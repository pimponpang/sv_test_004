<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SocioVoice SHINBASHI | sv_shinbashi_v1_09</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200');
    :root{
      --brand:#00897B;
      --bg:#eee;
      --text:#333;
      --frameMax:414px;
    }
    body{
      font-family:'Inter','Noto Sans JP',system-ui,-apple-system,'Segoe UI',sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }
    /* Phone frame */
    #app-frame{
      max-width:var(--frameMax);
      margin:0 auto;
      height:100vh;
      background:#fff;
      position:relative;
      overflow:hidden;
      box-shadow:0 0 30px rgba(0,0,0,.1);
    }
    /* Screens */
    .screen{
      position:absolute; inset:0;
      background:#fff;
      display:none;
      opacity:0;
      transition:opacity .25s ease;
      overflow:hidden;
    }
    .screen.active{ display:block; opacity:1; z-index:10; }
    /* Scroll area within screens (keeps bottom tab fixed) */
    .screen-scroll{
      height:100%;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:92px; /* bottom tab + safe area */
    }
    /* Bottom tab */
    .tabbar{
      position:absolute;
      left:0; right:0; bottom:0;
      width:100%;
      background:#fff;
      border-top:1px solid #f3f4f6;
      display:flex;
      justify-content:space-around;
      padding:10px 0 18px;
      z-index:60;
    }
    .tabbtn{ color:#9ca3af; font-size:10px; font-weight:700; display:flex; flex-direction:column; align-items:center; gap:4px; width:25%; }
    .tabbtn .ms{ font-family:'Material Symbols Rounded'; font-size:24px; font-variation-settings:'FILL' 0,'wght' 500,'GRAD' 0,'opsz' 24; }
    .ms.filled{ font-variation-settings:'FILL' 1,'wght' 600,'GRAD' 0,'opsz' 24; }
    .tabbtn.active{ color:var(--brand); }
    /* Header */
    .header{
      position:sticky;
      top:0;
      z-index:50;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid #f3f4f6;
    }

    /* Brand wordmark (Splash + Headers unified) */
.sv-wordmark{
  font-family:'Zen Maru Gothic','Inter','Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Sans','Noto Sans JP',sans-serif;
  font-weight:700;
  letter-spacing:.035em;
  text-transform:uppercase;
  line-height:1.0;
  white-space:nowrap;
  opacity:.98;
}
.sv-wordmark--header{ font-size:20px; }
.sv-wordmark--splash{ font-size:32px; }
.sv-gap{ display:inline-block; width:.18em; }

.header-avatar{ border-radius:9999px !important; }

/* Favorites screen (Material 3 Expressive-ish, minimal & clean) */
    .segmented{
      display:flex;
      gap:4px;
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(15,23,42,.04);
    }
    .segbtn{
      flex:1;
      height:36px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      color:#64748b;
      background:transparent;
    }
    .segbtn.active{
      background:#fff;
      color:var(--brand);
      border:1px solid rgba(0,137,123,.18);
    }
    .m3-card{
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      background:#fff;
    }
    /* Material Symbols helper */
    .ms{
      font-family:'Material Symbols Rounded';
      font-weight:500;
      font-style:normal;
      line-height:1;
      display:inline-block;
      vertical-align:middle;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
      font-variation-settings:'FILL' 0,'wght' 500,'GRAD' 0,'opsz' 24;
    }
    .ms.fill{ font-variation-settings:'FILL' 1,'wght' 600,'GRAD' 0,'opsz' 24; }
    /* Components */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.10);
      background:rgba(255,255,255,.70);
      color:#111827;
      font-size:12px;
      font-weight:700;
      line-height:1;
      box-shadow:0 1px 0 rgba(17,24,39,.04);
    }
    .badge--soft-teal{
      border-color:rgba(0,137,123,.18);
      background:rgba(0,137,123,.08);
      color:#0f766e;
    }
    .badge--soft-amber{
      border-color:rgba(245,158,11,.25);
      background:rgba(245,158,11,.10);
      color:#92400e;
    }
    .badge--soft-slate{
      border-color:rgba(15,23,42,.14);
      background:rgba(15,23,42,.06);
      color:#0f172a;
    }
    .badge-shop{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .post-official{ background:#F7FFFD; border-left:4px solid var(--brand); }
    .post-progress{ background:#F8FAFC; border-left:4px solid #111827; }
    .post-trend{ background:#FFFBEB; border-left:4px solid #F59E0B; }

    .img-placeholder{
      background:#e5e7eb;
      border-radius:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#9ca3af;
      font-size:12px;
      font-weight:900;
      position:relative;
      overflow:hidden;
    }
    .img-placeholder:after{
      content:"image";
      font-family:'Material Symbols Rounded';
      font-size:26px;
      opacity:.55;
      margin-left:8px;
    }
    /* Ticket */
    .ticket-dashed{
      border:2px dashed var(--brand);
      background:#F0FDFA;
      position:relative;
    }
    .ticket-notch{
      position:absolute;
      width:16px; height:16px;
      background:#fff;
      border-radius:50%;
      top:50%;
      transform:translateY(-50%);
      z-index:1;
    }
    /* Guest blur */
    .blur-overlay{
      position:absolute;
      left:0; right:0; bottom:92px; /* above tab bar */
      height:220px;
      background:linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1) 42%);
      display:flex;
      align-items:flex-end;
      padding:18px;
      z-index:40;
    }
    /* Floating Action Button */
    .fab{
      position:absolute;
      right:16px;
      bottom:108px;
      width:56px;
      height:56px;
      border-radius:999px;
      background:var(--brand);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 18px 30px rgba(0,0,0,.18);
      z-index:70;
    }
    .fab .ms{ font-size:28px; }
    /* Modal */
    .modal{ display:none; }
    .modal.active{ display:flex; }
    /* Small helper */
    .tap{ cursor:pointer; }

    
    
    
    /* --- M3 Expressive-ish chips (v13.3.8) --- */
    .chip{
      box-sizing:border-box;
      display:inline-flex;
      align-items:center;
      gap:6px;

      height:28px;                  /* unified height */
      padding:0 12px;               /* unified padding */
      border-radius:999px;

      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.80);
      color:#0f172a;

      font-size:12px;               /* unified type */
      font-weight:700;
      line-height:1;
      letter-spacing:.01em;
      white-space:nowrap;

      backdrop-filter:saturate(140%) blur(10px);
      -webkit-backdrop-filter:saturate(140%) blur(10px);
      box-shadow:0 1px 0 rgba(15,23,42,.05);
    }
    .chip .ms{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;               /* optically balanced in 28px */
      line-height:1;
    }
    .chip--teal{ border-color:rgba(0,137,123,.22); background:rgba(0,137,123,.10); color:#0f766e; }
    .chip--amber{ border-color:rgba(245,158,11,.26); background:rgba(245,158,11,.12); color:#92400e; }
    .chip--purple{ border-color:rgba(139,92,246,.26); background:rgba(139,92,246,.12); color:#5b21b6; }
    .chip--slate{ border-color:rgba(15,23,42,.16); background:rgba(15,23,42,.06); color:#0f172a; }
    .chip--rose{ border-color:rgba(244,63,94,.26); background:rgba(244,63,94,.10); color:#9f1239; }
    .chip--outline{ background:transparent; }

    .name-row{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
    .meta-row{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; margin-top:6px; }

/* --- UI refinement (v13.2): consistent rhythm --- */
    :root{
      --gutter:16px;
      --radius:10px;
      --hairline:#eef0f3;
      --textSub:#6b7280;
    }
    #app-frame{
      border-radius:0;
    }
    .header{
      border-bottom:1px solid var(--hairline);
    }
    .tabbar{
      border-top:1px solid var(--hairline);
      padding-bottom:calc(14px + env(safe-area-inset-bottom));
    }
    .screen-scroll{
      padding-bottom:calc(92px + env(safe-area-inset-bottom));
    }
    /* unify card look without changing markup */
    article{
      -webkit-tap-highlight-color: transparent;
    }
    .badge{
      border-radius:6px;
    }
    .img-placeholder{
      border-radius:8px;
    }

  
    .icon-only{
      background:transparent;
      border:0;
      padding:6px;
      border-radius:9999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:#6b7280;
    }
    .icon-only:hover{ background:#f3f4f6; }
    .icon-only:active{ background:#e5e7eb; }

    /* Timeline action icons (slightly smaller) */
    .actions-row .ms{ font-size:20px; }



    /* SocioVoice Splash v11 mesh (integrated) */
    .screen.sv-splash{ background:#fff; display:none; align-items:center; justify-content:center; }
    .screen.active.sv-splash{ display:flex; }

    .sv-splash-mesh{
      position:absolute; inset:0;
      background:
        radial-gradient(125% 92% at 50% 5%,
          rgba(255,255,255,0.998) 0%,
          rgba(255,255,255,0.92) 38%,
          rgba(233,250,247,0.50) 64%,
          rgba(233,250,247,0.00) 80%),
        radial-gradient(135% 78% at 50% 50%,
          rgba(255,255,255,0.92) 0%,
          rgba(255,255,255,0.78) 30%,
          rgba(233,250,247,0.26) 56%,
          rgba(255,255,255,0.00) 76%),
        radial-gradient(92% 58% at 18% 38%,
          rgba(0,137,123,0.16) 0%,
          rgba(0,137,123,0.10) 46%,
          rgba(255,255,255,0.00) 76%),
        radial-gradient(96% 62% at 86% 34%,
          rgba(0,137,123,0.14) 0%,
          rgba(0,137,123,0.08) 48%,
          rgba(255,255,255,0.00) 78%),
        radial-gradient(112% 72% at 30% 74%,
          rgba(0,121,107,0.18) 0%,
          rgba(0,121,107,0.12) 50%,
          rgba(255,255,255,0.00) 82%),
        radial-gradient(116% 80% at 78% 78%,
          rgba(0,121,107,0.20) 0%,
          rgba(0,121,107,0.12) 54%,
          rgba(255,255,255,0.00) 84%),
        linear-gradient(to bottom,
          #F6FFFE 0%,
          rgba(233,250,247,0.84) 20%,
          rgba(0,137,123,0.08) 46%,
          rgba(0,137,123,0.20) 68%,
          rgba(0,121,107,0.40) 94%,
          rgba(0,121,107,0.42) 100%);
    }
    .sv-splash-mesh::after{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(58% 40% at 54% 58%,
          rgba(255,255,255,0.08) 0%,
          rgba(255,255,255,0.03) 64%,
          rgba(255,255,255,0.0) 86%);
      filter: blur(18px);
      opacity:.18;
      pointer-events:none;
    }
    .sv-splash-content{
      position:relative;
      height:100%;
      width:100%;
      display:grid;
      place-items:center;
      padding:
        calc(env(safe-area-inset-top) + 24px)
        calc(env(safe-area-inset-right) + 24px)
        calc(env(safe-area-inset-bottom) + 24px)
        calc(env(safe-area-inset-left) + 24px);
      box-sizing:border-box;
      text-align:center;
    }
    .clamp2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
  

    /* M3 progressive top tabs (clean + bold) */
    .m3tabs{display:flex; border-bottom:1px solid #f3f4f6; background:#fff;}
    .m3tab{flex:1; padding:12px 0; font-weight:900; font-size:14px; color:#9ca3af; position:relative; transition:color .18s ease;}
    .m3tab.active{color:var(--brand);} 
    .m3tab.active::after{content:''; position:absolute; left:18%; right:18%; bottom:-1px; height:3px; background:var(--brand); border-radius:999px;}

  
    /* Header notification badge */
    .notif-btn{ position:relative; }
    .notif-badge{
      position:absolute;
      top:2px; right:2px;
      min-width:16px;
      height:16px;
      padding:0 5px;
      border-radius:999px;
      background:#ef4444;
      color:#fff;
      font-size:10px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      line-height:1;
      border:2px solid #fff;
    }
    

    /* HOT SHINBASHI module */
    .hot-card{min-width:170px;max-width:190px}
    .hot-card:focus{outline:2px solid var(--brand);outline-offset:2px}
</style>
  <meta name="sv_version" content="sv_shinbashi_v1_09">
</head>
<body>
<div id="app-frame">

  <!-- SPLASH -->
  <section id="screen-splash" class="screen active sv-splash">
    <div class="sv-splash-mesh"></div>
    <div class="sv-splash-content">
      <div class="sv-wordmark sv-wordmark--splash text-[var(--brand)]" aria-label="SOCIO VOICE">SOCIO<span class="sv-gap"></span>VOICE</div>
    </div>
  </section>
<!-- GUEST (Preview timeline w/ blur CTA) -->
  <section id="screen-guest" class="screen">
    <div class="screen-scroll">
      <header class="header px-4 py-3 flex justify-between items-center">
        <div class="sv-wordmark sv-wordmark--header text-[var(--brand)]">SOCIO<span class="sv-gap"></span>VOICE</div>
        <div class="flex items-center gap-2">
          <span class="text-[10px] font-black bg-gray-100 text-gray-500 px-2 py-1 rounded">GUEST</span>
          <button class="tap notif-btn" onclick="openNotifications()" aria-label="é€šçŸ¥">
            <span class="ms text-[26px] text-gray-500">notifications</span>
            <span class="notif-badge hidden">0</span>
          </button>
          <button class="tap" onclick="openAccount()" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
            <div class="header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500">
              <span class="ms text-[22px]">person</span>
            </div>
          </button>
        </div>
      </header>

      <div class="px-0">
        <!-- same content as home but truncated (still clickable opens detail + guard) -->
        <article class="post-official p-4 border-b border-gray-100 tap" data-open="post-1">
          <div class="flex gap-3 mb-2">
            <div class="w-10 h-10 bg-white border border-gray-200 flex items-center justify-center text-[var(--brand)] rounded-full">
              <span class="ms">auto_awesome</span>
            </div>
            <div>
              <div class="flex items-center gap-2">
                <span class="font-bold text-sm text-gray-900">SocioVoice æ–°æ©‹</span>
                <span class="text-[10px] border border-[var(--brand)] text-[var(--brand)] px-1 font-black">OPS</span>
              </div>
              <p class="text-xs text-gray-500">10åˆ†å‰</p>
            </div>
          </div>
          <div class="pl-[3.25rem]">
            <h3 class="font-bold text-sm mb-1">ã€ä»Šå¤œã€‘æ–°æ©‹ã®ç©ºæ°—ãƒ¡ãƒ¢ï¼ˆæ··é›‘/ã‚­ãƒ£ãƒƒãƒï¼‰</h3>
            <p class="text-sm text-gray-800 leading-relaxed">æ··é›‘ã—ã‚„ã™ã„é€šã‚Šãƒ»å£°ã‹ã‘ãŒå¤šã„ã‚¨ãƒªã‚¢ã®ç›®å®‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ç„¡ç†ã›ãšã€å±ãªã„ã¨æ€ã£ãŸã‚‰é›¢è„±ã§OKã€‚</p>
            <div class="mt-3 inline-flex items-center gap-2 text-xs text-gray-400">
              <span class="ms" style="font-size:18px">visibility</span> è©³ç´°ã‚’è¦‹ã‚‹
            </div>
          </div>
        </article>

        <article class="p-4 border-b border-gray-100 bg-white tap" data-open="post-2">
          <div class="flex justify-between mb-2">
            <div class="flex gap-3">
              <div class="w-10 h-10 bg-gray-100 flex items-center justify-center text-gray-600 rounded-full">
                <span class="ms">local_bar</span>
              </div>
              <div>
                <div class="flex items-center gap-2">
                  <span class="font-bold text-sm text-gray-900">365ãƒ™ãƒ¼ã‚«ãƒªãƒ¼</span>
                  <span class="badge badge-shop">SHOP</span>
                </div>
                <p class="text-xs text-gray-500">é§…å‰é€šã‚Š</p>
              </div>
            </div>
            <span class="border border-gray-900 text-gray-900 text-[10px] font-black px-2 py-0.5 h-6">ğŸ”¥ NOW</span>
          </div>
          <div class="pl-[3.25rem]">
            <p class="text-sm text-gray-900 mb-3">ãŸã ã„ã¾ã‚¯ãƒ­ãƒ¯ãƒƒã‚µãƒ³ãŒç„¼ãä¸ŠãŒã‚Šã¾ã—ãŸï¼ğŸ¥</p>
            <div class="img-placeholder w-full aspect-video mb-3 rounded-sm">[Image: Fresh Croissants]</div>
            <div class="flex gap-5 text-gray-400 text-sm">
              <button class="inline-flex items-center gap-1" data-action="requires-verify"><span class="ms">favorite</span> 14</button>
              <button class="inline-flex items-center gap-1" data-action="requires-verify"><span class="ms">chat_bubble</span> 2</button>
              <button class="inline-flex items-center gap-1" data-action="requires-verify"><span class="ms">share</span></button>
            </div>
          </div>
        </article>

        <div class="p-4 border-b border-gray-100 opacity-50 blur-[2px]">
          <div class="flex gap-3">
            <div class="w-10 h-10 bg-gray-200 rounded-full"></div>
            <div class="h-4 w-40 bg-gray-200 rounded"></div>
          </div>
          <div class="mt-2 h-16 w-full bg-gray-200 rounded"></div>
        </div>
        <div class="p-4 border-b border-gray-100 opacity-30 blur-[4px]">
          <div class="mt-2 h-16 w-full bg-gray-200 rounded"></div>
        </div>
      </div>
    </div>

    <div class="blur-overlay">
      <div class="w-full text-center">
        <p class="font-black text-gray-800 mb-1">ä¼šå“¡ç™»éŒ²ã§â€œå…¨éƒ¨è¦‹ãˆã‚‹â€</p>
        <p class="text-xs text-gray-500 mb-4">æŠ•ç¨¿ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€SMSãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è§£æ”¾ã€‚</p>
        <button class="w-full bg-[var(--brand)] text-white font-black py-3 rounded-sm shadow" onclick="nav('signup-1')">æ–°è¦ç™»éŒ²ã—ã¦ã¯ã˜ã‚ã‚‹</button>
        <button class="mt-3 text-xs text-gray-400" onclick="quickLogin()">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆMockï¼‰</button>
      </div>
    </div>
  </section>

  <!-- SIGNUP 1 -->
  <section id="screen-signup-1" class="screen">
    <div class="screen-scroll px-6 pt-10">
      <div class="w-full bg-gray-100 h-1 mb-8"><div class="bg-[var(--brand)] h-1 w-1/3"></div></div>
      <h2 class="text-2xl font-black mb-2">ã‚ˆã†ã“ãã€‚</h2>
      <p class="text-gray-500 mb-8">ã¾ãšã¯ã€è¡—ã§ä½¿ã†åå‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</p>

      <label class="text-xs font-black text-gray-400 block mb-1">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
      <input id="input-nick" class="w-full px-3 py-3 border border-gray-200 rounded-sm text-base mb-4 focus:outline-none focus:border-[var(--brand)]" placeholder="ä¾‹: ãƒ’ãƒ­ã‚·" oninput="checkStep1()" />

      <div class="mt-6 flex justify-center">
        <div id="icon-preview" class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center text-gray-300">
          <span class="ms" style="font-size:40px">person</span>
        </div>
      </div>
      <p class="text-center text-xs text-gray-400 mt-2">ã‚ãªãŸã®ã‚¢ã‚¤ã‚³ãƒ³ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ï¼ˆMockï¼‰</p>

      <button id="btn-step1" class="mt-8 w-full bg-[var(--brand)] text-white font-black py-3 rounded-sm opacity-50 cursor-not-allowed" disabled onclick="nav('signup-2')">æ¬¡ã¸</button>
      <button class="mt-4 w-full text-xs text-gray-400" onclick="nav('guest')">æˆ»ã‚‹</button>
    </div>
  </section>

  <!-- SIGNUP 2 -->
  <section id="screen-signup-2" class="screen">
    <div class="screen-scroll px-6 pt-10">
      <div class="w-full bg-gray-100 h-1 mb-8"><div class="bg-[var(--brand)] h-1 w-2/3"></div></div>
      <h2 class="text-2xl font-black mb-2">ã‚ãªãŸã¯ã©ã‚“ãªäººï¼Ÿ</h2>
      <p class="text-gray-500 mb-8">è¡Œå‹•åœã¨å¹´é½¢ã‹ã‚‰ã€å±æ€§ãƒãƒƒã‚¸ã‚’ä½œã‚Šã¾ã™ï¼ˆMockï¼‰ã€‚</p>

      <label class="text-xs font-black text-gray-400 block mb-1">è¡Œå‹•åœï¼ˆæ–°æ©‹å‘¨è¾ºãƒ»ä»»æ„ï¼‰</label>
      <input id="input-area" type="tel" class="w-full px-3 py-3 border border-gray-200 rounded-sm text-base mb-4 focus:outline-none focus:border-[var(--brand)]" placeholder="ä¾‹: æ–°æ©‹ / æ±ç•™ / å†…å¹¸ç”º / è™ãƒé–€" oninput="simulateBadgeGen()" />

      <label class="text-xs font-black text-gray-400 block mb-1">ç”Ÿå¹´æœˆæ—¥</label>
      <input id="input-birth" type="date" class="w-full px-3 py-3 border border-gray-200 rounded-sm text-base mb-4 focus:outline-none focus:border-[var(--brand)]" onchange="simulateBadgeGen()" />

      <div id="badge-container" class="bg-gray-50 border border-dashed border-gray-300 rounded-lg p-4 min-h-[100px] flex flex-wrap gap-2 content-center justify-center">
        <span class="text-xs text-gray-400">ã“ã“ã«ãƒãƒƒã‚¸ãŒç”Ÿæˆã•ã‚Œã¾ã™â€¦</span>
      </div>

      <button id="btn-step2" class="mt-8 w-full bg-[var(--brand)] text-white font-black py-3 rounded-sm opacity-50 cursor-not-allowed" disabled onclick="nav('signup-3')">æ¬¡ã¸</button>
      <button class="mt-4 w-full text-xs text-gray-400" onclick="nav('signup-1')">æˆ»ã‚‹</button>
    </div>
  </section>

  <!-- SIGNUP 3 -->
  <section id="screen-signup-3" class="screen">
    <div class="screen-scroll px-6 pt-10">
      <div class="w-full bg-gray-100 h-1 mb-8"><div class="bg-[var(--brand)] h-1 w-full"></div></div>
      <h2 class="text-2xl font-black mb-2">æº–å‚™å®Œäº†ã§ã™ã€‚</h2>
      <p class="text-gray-500 mb-8">æœ€å¾Œã«åˆ©ç”¨è¦ç´„ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>

      <div class="h-36 bg-gray-50 border border-gray-200 rounded-sm p-3 text-xs text-gray-500 overflow-y-auto mb-4">
        <p class="font-black text-gray-700 mb-2">åˆ©ç”¨è¦ç´„ï¼ˆè¦ç´„ï¼‰</p>
        <ol class="list-decimal pl-4 space-y-1">
          <li>ç›¸äº’ä¿¡é ¼ã®åŸå‰‡ï¼ˆè¿·æƒ‘è¡Œç‚ºãƒ»è™šå½æƒ…å ±ã¯åœæ­¢å¯¾è±¡ï¼‰</li>
          <li>æŠ•ç¨¿ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯SMSãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è§£æ”¾</li>
          <li>åº—èˆ—ï¼ˆæ³•äººï¼‰ã¯æ³•äººç•ªå·ã§ç™»éŒ²ã—ã€æ‹›å¾…åˆ¶ã§é‹ç”¨</li>
        </ol>
      </div>

      <label class="flex items-center gap-3 mb-8 p-3 border border-gray-200 rounded-sm cursor-pointer hover:bg-gray-50">
        <input type="checkbox" id="check-terms" class="w-5 h-5 accent-[var(--brand)]" onchange="checkStep3()" />
        <span class="text-sm font-black">è¦ç´„ã«åŒæ„ã—ã¦å§‹ã‚ã‚‹</span>
      </label>

      <button id="btn-step3" class="w-full bg-[var(--brand)] text-white font-black py-3 rounded-sm opacity-50 cursor-not-allowed" disabled onclick="finishSignup()">SocioVoiceã‚’å§‹ã‚ã‚‹</button>
      <button class="mt-4 w-full text-xs text-gray-400" onclick="nav('signup-2')">æˆ»ã‚‹</button>
    </div>
  </section>

  <!-- HOME (Timeline) -->
  <section id="screen-home" class="screen">
    <div class="screen-scroll">
      <header class="header px-4 py-3 flex justify-between items-center">
        <div class="sv-wordmark sv-wordmark--header text-[var(--brand)]">SOCIO<span class="sv-gap"></span>VOICE</div>
        <div class="flex items-center gap-2">
        <button class="tap notif-btn" onclick="openNotifications()" aria-label="é€šçŸ¥">
          <span class="ms text-[26px] text-gray-500">notifications</span>
          <span class="notif-badge hidden">0</span>
        </button>
        <button class="tap" onclick="openAccount()" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
          <div class="header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500">
            <span class="ms text-[22px]">person</span>
          </div>
        </button>
      </div>
      </header>
      <div id="home-banner" class="px-4 pt-4"></div>

      <div id="timeline" class="px-0 pb-4">
        <!-- posts injected -->
      </div>
    </div>

    <!-- FAB: post create -->
    <button class="fab tap" onclick="openComposer()" aria-label="æŠ•ç¨¿ä½œæˆ">
      <span class="ms fill">edit</span>
    </button>

  </section>

  <!-- FOLLOW TAB -->
  <section id="screen-follow" class="screen">
    <div class="screen-scroll">
      <header class="header px-4 py-3 flex justify-between items-center">
        <div class="sv-wordmark sv-wordmark--header text-[var(--brand)]">SOCIO<span class="sv-gap"></span>VOICE</div>
        <div class="flex items-center gap-2">
        <button class="tap notif-btn" onclick="openNotifications()" aria-label="é€šçŸ¥">
          <span class="ms text-[26px] text-gray-500">notifications</span>
          <span class="notif-badge hidden">0</span>
        </button>
        <button class="tap" onclick="openAccount()" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
          <div class="header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500">
            <span class="ms text-[22px]">person</span>
          </div>
        </button>
      </div>
      </header>

      <div class="m3tabs sticky top-[49px] z-40">
        <button id="fav-tab-liked" class="m3tab active" onclick="setFavMode('liked')">ã„ã„ã­</button>
        <button id="fav-tab-want" class="m3tab" onclick="setFavMode('want')">è¡ŒããŸã„</button>
        <button id="fav-tab-follow" class="m3tab" onclick="setFavMode('follow')">ãƒ•ã‚©ãƒ­ãƒ¼</button>
        <button id="fav-tab-feed" class="m3tab" onclick="setFavMode('feed')">ãƒ•ã‚©ãƒ­ãƒ¼TL</button>
      </div>

      <div class="px-4 pt-4">
<!-- Follow feed panel -->
        <div id="fav-panel-feed" class="hidden">
          <div class="text-xs text-gray-500 leading-relaxed">
            ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹äººãƒ»ãŠåº—ã ã‘ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§ã™ï¼ˆå…¬å¼ã¯å¸¸ã«è¡¨ç¤ºï¼‰ã€‚
          </div>

          <div id="fav-feed-timeline" class="mt-3 -mx-4 border-y border-gray-100 bg-white"></div>

          <div id="fav-feed-empty" class="mt-10 text-center text-sm text-gray-400 hidden">
            ã¾ã ãƒ•ã‚©ãƒ­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>

        
        <!-- Want panel -->
        <div id="fav-panel-want" class="hidden">
          <div class="text-xs text-gray-500 leading-relaxed">
            <span class="ms align-[-2px] text-gray-400">star</span>ã€Œè¡ŒããŸã„ã€ã«å…¥ã‚ŒãŸæŠ•ç¨¿ã®ä¸€è¦§ã§ã™ã€‚
          </div>

          <div id="fav-want-timeline" class="mt-3 -mx-4 border-y border-gray-100 bg-white"></div>

          <div id="fav-want-empty" class="mt-10 text-center text-sm text-gray-400 hidden">
            ã¾ã ã€Œè¡ŒããŸã„ã€ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>

<!-- Follow panel -->
        <div id="fav-panel-follow">
          <div class="text-xs text-gray-500 leading-relaxed">
            ãƒ•ã‚©ãƒ­ãƒ¼ã¯ã€Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ‰±ã„ã€ãªã®ã§ã€SMSãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ç¢ºå®šã§ãã¾ã™ã€‚<br>
            â€»ä¼šå“¡ç™»éŒ²ã ã‘ã§ã‚‚ã€æŠ•ç¨¿ã¯å…¨éƒ¨é–²è¦§ã§ãã¾ã™ã€‚
          </div>

          
          <div class="mt-4 -mx-4 border-y border-gray-100 bg-white">
            <div class="px-4 py-3 flex items-center justify-between gap-3 border-b border-gray-100">
              <div class="flex items-center gap-3 min-w-0">
                <div class="w-10 h-10 bg-white border border-gray-200 flex items-center justify-center text-[var(--brand)] rounded-full">
                  <span class="ms">auto_awesome</span>
                </div>
                <div class="min-w-0">
                  <div class="font-black text-sm truncate">SocioVoice æ–°æ©‹</div>
                  <div class="text-xs text-gray-500">é‹å–¶</div>
                </div>
              </div>
              <button class="px-3 py-2 text-xs font-black border border-gray-300 rounded-full text-[var(--brand)] tap" data-action="requires-verify" onclick="toggleFollow(this,'ops_shinbashi')">ãƒ•ã‚©ãƒ­ãƒ¼</button>
            </div>

            <div class="px-4 py-3 flex items-center justify-between gap-3 border-b border-gray-100">
              <div class="flex items-center gap-3 min-w-0">
                <div class="w-10 h-10 bg-white border border-gray-200 flex items-center justify-center text-[var(--brand)] rounded-full">
                  <span class="ms">bakery_dining</span>
                </div>
                <div class="min-w-0">
                  <div class="font-black text-sm truncate">ç«‹å‘‘ã¿ã€ŒéŠ€ã®æ¨½ã€</div>
                  <div class="text-xs text-gray-500">SHOP</div>
                </div>
              </div>
              <button class="px-3 py-2 text-xs font-black border border-gray-300 rounded-full text-[var(--brand)] tap" data-action="requires-verify" onclick="toggleFollow(this,'bar_ginnotaru')">ãƒ•ã‚©ãƒ­ãƒ¼</button>
            </div>

            <div class="px-4 py-3 flex items-center justify-between gap-3">
              <div class="flex items-center gap-3 min-w-0">
                <div class="w-10 h-10 bg-gray-800 text-white flex items-center justify-center rounded-full">
                  <span class="ms">restaurant</span>
                </div>
                <div class="min-w-0">
                  <div class="font-black text-sm truncate">ä¸²ç„¼ã ã—ã‚“ã°ã—å¤ªéƒ</div>
                  <div class="text-xs text-gray-500">SHOP</div>
                </div>
              </div>
              <button class="px-3 py-2 text-xs font-black border border-gray-300 rounded-full text-[var(--brand)] tap" data-action="requires-verify" onclick="toggleFollow(this,'kushiyaki_taro')">ãƒ•ã‚©ãƒ­ãƒ¼</button>
            </div>
          </div>

        </div>

        <!-- Liked panel -->
        <div id="fav-panel-liked" class="hidden">
          <div class="text-xs text-gray-500 leading-relaxed">
            â™¡ï¼ˆã„ã„ã­ï¼‰ã—ãŸæŠ•ç¨¿ãŒã“ã“ã«æ®‹ã‚Šã¾ã™ã€‚
          </div>

          <div id="liked-posts" class="mt-3 -mx-4 border-y border-gray-100 bg-white"></div>

          <div id="liked-empty" class="mt-10 text-center text-sm text-gray-400">
            ã¾ã ã€Œã„ã„ã­ã€ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>
      </div>
    </div>

  </section>

  
  <!-- SEARCH TAB -->
  <section id="screen-search" class="screen">
    <div class="screen-scroll">
      <header class="header px-4 py-3 flex justify-between items-center">
        <div class="sv-wordmark sv-wordmark--header text-[var(--brand)]">SOCIO<span class="sv-gap"></span>VOICE</div>
        <div class="flex items-center gap-2">
        <button class="tap notif-btn" onclick="openNotifications()" aria-label="é€šçŸ¥">
          <span class="ms text-[26px] text-gray-500">notifications</span>
          <span class="notif-badge hidden">0</span>
        </button>
        <button class="tap" onclick="openAccount()" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
          <div class="header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500">
            <span class="ms text-[22px]">person</span>
          </div>
        </button>
      </div>
      </header>

      <div class="px-4 pt-4 pb-24">
        <div class="flex items-center gap-2 border border-gray-200 bg-white rounded-sm px-3 py-2">
          <span class="ms text-gray-400">search</span>
          <input id="search-input" class="w-full outline-none text-sm" placeholder="æŠ•ç¨¿ãƒ»åº—èˆ—ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œç´¢" oninput="onSearchInput(this.value)" />
          <button class="tap text-gray-400" onclick="clearSearch()" aria-label="ã‚¯ãƒªã‚¢"><span class="ms">close</span></button>
        </div>

        <div id="search-suggest" class="mt-4"></div>

        <div class="mt-4">
          <div class="text-xs text-gray-500">æ¤œç´¢çµæœ</div>
          <div id="search-results" class="mt-2 border-t border-gray-100"></div>
          <div id="search-empty" class="hidden text-sm text-gray-400 mt-6">è©²å½“ã™ã‚‹æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </div>
  </section>

<!-- NOTIFICATIONS TAB -->
  
<section id="screen-plan" class="screen">
  <div class="screen-scroll">
    <header class="header px-4 py-3 flex justify-between items-center">
      <div class="sv-wordmark sv-wordmark--header text-[var(--brand)]">SOCIO<span class="sv-gap"></span>VOICE</div>
      <div class="flex items-center gap-2">
        <button class="tap notif-btn" onclick="openNotifications()" aria-label="é€šçŸ¥">
          <span class="ms text-[26px] text-gray-500">notifications</span>
          <span class="notif-badge hidden">0</span>
        </button>
        <button class="tap" onclick="openAccount()" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
          <div class="header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500">
            <span class="ms text-[22px]">person</span>
          </div>
        </button>
      </div>
    
</header>

    <div class="px-4 pt-3">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-1 text-xs text-gray-500 font-black">
          <span class="ms text-[18px]">military_tech</span>
          <span id="plan-rank-label">ãƒ©ãƒ³ã‚¯ 1</span>
        </div>
        <button class="tap px-3 py-2 text-xs font-black rounded-sm border border-gray-200 bg-white text-gray-700 flex items-center gap-1" onclick="openCreatePlan()" aria-label="ä¼ç”»ã‚’ä½œæˆ">
          <span class="ms text-[18px]">add</span>
          ä¼ç”»ã‚’ä½œæˆ
        </button>
      </div>
    </div>

    <div class="px-4 pt-3 pb-24">

      <div class="text-base font-black text-gray-900">ä¼ç”»</div>
      <div class="text-xs text-gray-500 mt-1 leading-relaxed">
        æ–°æ©‹ã®ã€Œç¸›ã‚Šã€ã§éŠã¶ã€‚æŠ•ç¨¿â†’è¡Œå‹•ã«ã¤ãªãŒã‚‹ã‹ã‚’æ¸¬ã‚‹å…¥å£ã€‚
      </div>

      <div class="mt-4 p-4 rounded-xl border border-gray-100 bg-white">
        <div class="text-xs text-gray-500 font-bold">ä»Šæ—¥ã®ä¼ç”»</div>
        <div class="text-sm font-black mt-1">çµ‚é›»ã¾ã§ï¼šç«‹ã¡é£²ã¿ç¸›ã‚Šï¼ˆã€œ3,000å††ï¼‰</div>
        <div class="text-xs text-gray-500 mt-1">ã€Œè¡ŒããŸã„ã€â†’ç¾åœ°ã§1æŠ•ç¨¿ï¼ˆã¾ãŸã¯ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰ã§å®Œèµ°ã€‚</div>
        <div class="mt-3 flex gap-2">
          <button class="tap px-3 py-2 text-xs font-black rounded-lg bg-[var(--brand)] text-white" onclick="guardAction(()=>joinTodayPlan())">å‚åŠ </button>
          <button class="tap px-3 py-2 text-xs font-black rounded-lg border border-gray-200 bg-white text-gray-700" onclick="openPlanDetail('today')">è©³ç´°</button>
        </div>
      </div>


      <div id="plan-joined" class="mt-4 p-4 rounded-xl border border-gray-100 bg-white hidden">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-xs text-gray-500 font-bold">å‚åŠ ä¸­</div>
            <div class="text-sm font-black mt-1">çµ‚é›»ã¾ã§ï¼šç«‹ã¡é£²ã¿ç¸›ã‚Šï¼ˆã€œ3,000å††ï¼‰</div>
            <div id="plan-progress" class="text-xs text-gray-500 mt-1">ã‚ã¨1ã‚¹ãƒ†ãƒƒãƒ—ï¼šæŠ•ç¨¿ï¼ˆã¾ãŸã¯ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰</div>
          </div>
          <div class="w-9 h-9 rounded-full border border-gray-100 bg-white flex items-center justify-center text-gray-500 shrink-0">
            <span class="ms">flag</span>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="tap px-3 py-2 text-xs font-black rounded-lg bg-[var(--brand)] text-white" onclick="guardAction(()=>{ openComposer({planId: state.plan?.planId || 'today'}); toast('æŠ•ç¨¿ç”»é¢ã¸ï¼ˆä¼ç”»å‚åŠ ä¸­ï¼‰'); })">æŠ•ç¨¿ã™ã‚‹</button>
          <button class="tap px-3 py-2 text-xs font-black rounded-lg border border-gray-200 bg-white text-gray-700" onclick="guardAction(()=>completeTodayPlan())">å®Œèµ°</button>
        </div>
      </div>


      <div class="mt-4">
        <div class="text-xs text-gray-500 font-black mb-2">ã¿ã‚“ãªã®ä¼ç”»</div>
        <div id="plan-list" class="space-y-2"></div>
      </div>
    </div>
  </div>
</section>


<section id="screen-plan-detail" class="screen">
  <div class="screen-scroll">
    <header class="header px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button class="tap text-gray-500 px-2 py-2" onclick="closePlanDetail()" aria-label="æˆ»ã‚‹"><span class="ms">arrow_back</span></button>
        <div class="font-black text-base text-gray-900">ä¼ç”»è©³ç´°</div>
      </div>
      <button class="tap" onclick="openAccount()" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
        <div class="header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500">
          <span class="ms text-[22px]">person</span>
        </div>
      </button>
    </header>

    <div class="px-4 pt-4 pb-24">
      <div class="p-4 rounded-xl border border-gray-100 bg-white">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-xs text-gray-500 font-bold" id="plan-detail-kicker">â€”</div>
            <div class="text-lg font-black mt-1 leading-snug" id="plan-detail-title">â€”</div>
            <div class="text-xs text-gray-500 mt-1" id="plan-detail-sub">â€”</div>
          </div>
          <div class="w-10 h-10 rounded-full border border-gray-100 bg-white flex items-center justify-center text-gray-500 shrink-0">
            <span class="ms" id="plan-detail-icon">flag</span>
          </div>
        </div>

        <div class="mt-3 flex flex-wrap gap-2" id="plan-detail-rules"></div>

        <div class="mt-4 flex gap-2">
          <button id="plan-detail-joinbtn" class="tap px-3 py-2 text-xs font-black rounded-lg bg-[var(--brand)] text-white" onclick="guardAction(()=>joinPlanFromDetail())">å‚åŠ </button>
          <button id="plan-detail-postbtn" class="tap px-3 py-2 text-xs font-black rounded-lg border border-gray-200 bg-white text-gray-700" onclick="guardAction(()=>postInPlanFromDetail())">ä¼ç”»ã«æŠ•ç¨¿</button>
        </div>

        <div class="mt-3 text-[11px] text-gray-500 leading-relaxed">
          å‚åŠ ã¯ãƒ­ã‚°å–å¾—ã®ãŸã‚ã€‚æŠ•ç¨¿ã¯æ—¢å­˜ã®æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’æµç”¨ã—ã¦ã€ä¼ç”»ã«ç´ã¥ã‘ã‚‹ï¼ˆMockï¼‰ã€‚
        </div>
      
      <div class="mt-4">
        <div class="text-xs text-gray-500 font-black mb-2">ã“ã®ä¼ç”»ã®æŠ•ç¨¿</div>
        <div id="plan-detail-feed" class="space-y-3"></div>
        <div id="plan-detail-empty" class="hidden text-sm text-gray-400 mt-6">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
      </div>
</div>
    </div>
  </div>
</section>

<section id="screen-notif" class="screen">
  <div class="screen-scroll">
    <header class="header px-4 py-3 flex justify-between items-center">
<div class="flex items-center gap-2">
    <button class="tap text-gray-500 px-2 py-2" onclick="closeNotifications()" aria-label="æˆ»ã‚‹"><span class="ms">arrow_back</span></button>
    <div class="font-black text-base text-gray-900">é€šçŸ¥</div>
  </div>
  <button class="tap" onclick="openAccount()" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
    <div class="header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500">
      <span class="ms text-[22px]">person</span>
    </div>
  </button>
</header>

    <div class="px-4 pt-3 pb-24">
      <div id="notif-list" class="border-t border-gray-100"></div>
      <div id="notif-empty" class="hidden text-sm text-gray-400 mt-8">é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</div>
    </div>
  </div>
</section>

  <!-- ACCOUNT TAB -->
  
<section id="screen-account" class="screen">
  <div class="screen-scroll">
    <header class="header px-4 py-3 flex justify-between items-center">
        <div class="sv-wordmark sv-wordmark--header text-[var(--brand)]">SOCIO<span class="sv-gap"></span>VOICE</div>
        <button class="tap" onclick="closeAccount()" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
          <div class="header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500">
            <span class="ms text-[22px]">person</span>
          </div>
        </button>
      </header>

    <div class="px-4 pt-4 pb-24">
      <div class="text-xs text-gray-500">ç¾åœ¨ã®åˆ©ç”¨çŠ¶æ…‹</div>
      <div class="font-black text-base mt-1" id="status-label">â€”</div>
      <div class="text-xs text-gray-500 mt-1" id="status-desc">â€”</div>

      <div class="mt-5 border-t border-gray-100">
        <button class="w-full flex items-center justify-between py-4 border-b border-gray-100 tap" onclick="goVerifyFromAccount()">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><span class="ms text-[20px]">verified_user</span></div>
            <div class="text-sm font-black">SMSãƒ­ã‚°ã‚¤ãƒ³</div>
          </div>
          <span class="ms text-gray-400">chevron_right</span>
        </button>

        <div class="py-4 border-b border-gray-100">
          <div class="text-xs text-gray-500 mb-2">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡æ›¿</div>
          <div class="flex gap-2">
            <button class="tap px-3 py-2 border border-gray-200 rounded-sm text-sm font-black" onclick="switchPersona('personal')">å€‹äºº</button>
            <button class="tap px-3 py-2 border border-gray-200 rounded-sm text-sm font-black" onclick="switchPersona('shop:365')">åº—èˆ—</button>
          </div>
          <div class="text-xs text-gray-400 mt-2">â€»ãƒ¢ãƒƒã‚¯ï¼šå®Ÿé‹ç”¨ã¯æ‹›å¾…åˆ¶ã‚’æƒ³å®š</div>
        </div>

        <div class="py-4 border-b border-gray-100">
          <div class="text-xs text-gray-500 mb-2">ãƒ‡ãƒãƒƒã‚°ï¼ˆãƒ¢ãƒƒã‚¯æ¤œè¨¼ç”¨ï¼‰</div>
          <div class="flex flex-wrap gap-2">
            <button class="tap px-3 py-2 border border-gray-200 rounded-sm text-sm" onclick="setStatus('guest')">guest</button>
            <button class="tap px-3 py-2 border border-gray-200 rounded-sm text-sm" onclick="setStatus('member')">member</button>
            <button class="tap px-3 py-2 border border-gray-200 rounded-sm text-sm" onclick="setStatus('verified')">verified</button>
          </div>
        </div>

        <div class="py-4 border-b border-gray-100">
          <div class="text-xs text-gray-500 mb-2">è¨­å®š</div>
          <div class="space-y-2">
            <button class="w-full flex items-center justify-between py-2 tap" onclick="toast('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´ï¼ˆMockï¼‰')">
              <div class="text-sm">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´</div><span class="ms text-gray-400">chevron_right</span>
            </button>
            <button class="w-full flex items-center justify-between py-2 tap" onclick="toast('é€šçŸ¥è¨­å®šï¼ˆMockï¼‰')">
              <div class="text-sm">é€šçŸ¥è¨­å®š</div><span class="ms text-gray-400">chevron_right</span>
            </button>
            <button class="w-full flex items-center justify-between py-2 tap" onclick="toast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆMockï¼‰')">
              <div class="text-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div><span class="ms text-gray-400">chevron_right</span>
            </button>
            <button class="w-full flex items-center justify-between py-2 tap" onclick="toast('é€€ä¼šï¼ˆMockï¼‰')">
              <div class="text-sm text-rose-600 font-black">é€€ä¼š</div><span class="ms text-gray-400">chevron_right</span>
            </button>
          </div>
        </div>
      </div>
      <div class="mt-6">
        <div class="text-xs text-gray-500 mb-2">ãŠåº—ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
        <div class="border border-gray-200 rounded-sm p-4 bg-gray-50">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-sm font-black">ãŠåº—ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ </div>
              <div class="text-xs text-gray-500 mt-1">æ³•äººç•ªå·â†’æ‹›å¾…åˆ¶ï¼ˆæ²»å®‰ã¨ä¿¡é ¼ï¼‰</div>
            </div>
            <button class="tap text-gray-500" onclick="openSwitcher()" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡æ›¿">
              <span class="ms">swap_horiz</span>
            </button>
          </div>
          <button class="btn-primary w-full mt-3" onclick="openSwitcher()">è¿½åŠ /åˆ‡æ›¿ã‚’é–‹ã</button>
        </div>
      </div>

    </div>
  </div>
</section>

  <!-- POST DETAIL -->

  
  <section id="screen-post" class="screen">
    <div class="screen-scroll">
      <header class="header px-3 py-3 flex items-center gap-2">
        <button class="tap text-gray-500 px-2 py-2" onclick="backFromPost()"><span class="ms">arrow_back</span></button>
        <div class="font-black text-base text-gray-900">æŠ•ç¨¿è©³ç´°</div>
      </header>
      <div id="post-detail" class="px-0"></div>
    </div>
  </section>

  <!-- COMPOSER -->
  <section id="screen-compose" class="screen">
    <div class="screen-scroll">
      <header class="header px-3 py-3 flex items-center justify-between">
        <button class="tap text-gray-500 px-2 py-2" onclick="closeComposer()"><span class="ms">close</span></button>
        <div class="font-black text-base text-gray-900">æŠ•ç¨¿ä½œæˆ</div>
        <button class="tap px-3 py-2 text-xs font-black rounded-sm bg-[var(--brand)] text-white" onclick="submitPost()" data-action="requires-verify">æŠ•ç¨¿</button>
      </header>

      <div class="px-4 pt-4">
        <div class="border border-gray-200 rounded-sm p-4">
          <div class="text-xs text-gray-500">ç™ºä¿¡è€…</div>
          <div class="font-black text-sm mt-1" id="compose-author">â€”</div>
        </div>
        <div id="compose-planbox" class="mt-3 border border-gray-200 rounded-sm px-4 py-3 bg-white hidden">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2 min-w-0">
              <span class="ms text-gray-500">flag</span>
              <div class="min-w-0">
                <div class="text-[11px] font-black text-gray-500">ä¼ç”»ã«æŠ•ç¨¿</div>
                <div id="compose-planname" class="text-sm font-black text-gray-900 truncate">â€”</div>
              </div>
            </div>
            <button class="tap px-2 py-2 text-gray-500" aria-label="ä¼ç”»ã‚’å¤–ã™" onclick="clearComposePlan()"><span class="ms">close</span></button>
          </div>
        </div>


        <div class="mt-3 border border-gray-200 rounded-sm p-4">
          <div class="text-xs font-black text-gray-500 mb-2">æŠ•ç¨¿ã‚¿ã‚¤ãƒ—</div>
          <div class="grid grid-cols-3 gap-2">
            <button class="py-3 text-xs font-black border border-gray-300 rounded-sm" onclick="setComposeType('normal')" id="type-normal">é€šå¸¸</button>
            <button class="py-3 text-xs font-black border border-gray-300 rounded-sm" onclick="setComposeType('report')" id="type-report">ä»Šå¤œãƒ¬ãƒ</button>
            <button class="py-3 text-xs font-black border border-gray-300 rounded-sm" onclick="setComposeType('petition')" id="type-petition">æ³¨æ„</button>
          </div>
        </div>

        <div class="mt-3 border border-gray-200 rounded-sm p-4">
          <div class="text-xs font-black text-gray-500 mb-3">è©•ä¾¡ï¼ˆä»»æ„ï¼‰</div>

          <div class="space-y-3">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 text-xs font-black text-gray-600">
                <span class="ms" style="font-size:18px">paid</span> ã‚³ã‚¹ãƒ‘
              </div>
              <div class="inline-flex rounded-sm overflow-hidden border border-gray-200">
                <button id="rate-cost-1" class="px-3 py-2 text-xs font-black" onclick="setComposeRating('cost',1)">å®‰ã„</button>
                <button id="rate-cost-2" class="px-3 py-2 text-xs font-black border-l border-gray-200" onclick="setComposeRating('cost',2)">ãµã¤ã†</button>
                <button id="rate-cost-3" class="px-3 py-2 text-xs font-black border-l border-gray-200" onclick="setComposeRating('cost',3)">é«˜ã‚</button>
              </div>
            </div>

            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 text-xs font-black text-gray-600">
                <span class="ms" style="font-size:18px">schedule</span> ã‚¿ã‚¤ãƒ‘
              </div>
              <div class="inline-flex rounded-sm overflow-hidden border border-gray-200">
                <button id="rate-time-1" class="px-3 py-2 text-xs font-black" onclick="setComposeRating('time',1)">æ—©ã„</button>
                <button id="rate-time-2" class="px-3 py-2 text-xs font-black border-l border-gray-200" onclick="setComposeRating('time',2)">ãµã¤ã†</button>
                <button id="rate-time-3" class="px-3 py-2 text-xs font-black border-l border-gray-200" onclick="setComposeRating('time',3)">é…ã„</button>
              </div>
            </div>

            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 text-xs font-black text-gray-600">
                <span class="ms" style="font-size:18px">groups</span> é›°å›²æ°—
              </div>
              <div class="inline-flex rounded-sm overflow-hidden border border-gray-200">
                <button id="rate-vibe-1" class="px-3 py-2 text-xs font-black" onclick="setComposeRating('vibe',1)">é™ã‹</button>
                <button id="rate-vibe-2" class="px-3 py-2 text-xs font-black border-l border-gray-200" onclick="setComposeRating('vibe',2)">ãµã¤ã†</button>
                <button id="rate-vibe-3" class="px-3 py-2 text-xs font-black border-l border-gray-200" onclick="setComposeRating('vibe',3)">è³‘ã‚„ã‹</button>
              </div>
            </div>
          </div>

          <div class="mt-3 text-[11px] text-gray-400 leading-relaxed">
            â€»åŒã˜ãƒœã‚¿ãƒ³ã‚’ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨è§£é™¤ã§ãã¾ã™ï¼ˆä»»æ„ï¼‰ã€‚
          </div>
        </div>

        <div class="mt-3 border border-gray-200 rounded-sm p-4">
          <div class="text-xs font-black text-gray-500 mb-2">æœ¬æ–‡</div>
          <textarea id="compose-text" class="w-full min-h-[140px] px-3 py-3 border border-gray-200 rounded-sm text-sm focus:outline-none focus:border-[var(--brand)]" placeholder="è¡—ã®æƒ…å ±ãƒ»ç›¸è«‡ãƒ»ãŠçŸ¥ã‚‰ã›ãªã©â€¦ï¼ˆMockï¼‰"></textarea>

          <div class="mt-3 flex items-center justify-between">
            <label class="flex items-center gap-2 text-xs font-black text-gray-600 cursor-pointer">
              <input id="compose-pinmap" type="checkbox" class="accent-[var(--brand)]" />
              ä»»æ„ã§ãƒ”ãƒ³ç•™ã‚ãƒãƒƒãƒ—ã‚’æ·»ä»˜ï¼ˆæŠ•ç¨¿å†…ã§å®Œçµï¼‰
            </label>
            <button class="text-xs font-black text-gray-500 border border-gray-200 px-3 py-2 rounded-sm" onclick="toast('å†™çœŸè¿½åŠ ï¼ˆMockï¼‰')" data-action="requires-verify">
              <span class="ms" style="font-size:18px">add_photo_alternate</span> å†™çœŸ
            </button>
          </div>

          <div class="mt-3 hidden" id="pinmap-preview">
            <div class="text-[11px] text-gray-500 mb-2">ãƒ”ãƒ³ç•™ã‚ãƒãƒƒãƒ—ï¼ˆMockï¼‰</div>
            <div class="img-placeholder w-full aspect-video rounded-sm">[Pinned Map]</div>
            <div class="text-[11px] text-gray-400 mt-2">â€»æ¨ªã¤ãªãŒã‚Šç„¡ã—ã€‚1æŠ•ç¨¿å†…ã§å®Œçµã€‚</div>
          </div>
        </div>

        <div class="mt-3 mb-6 text-xs text-gray-500 leading-relaxed">
          â€»æŠ•ç¨¿ãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»åŒæ„ãƒ»ãƒ•ã‚©ãƒ­ãƒ¼ç­‰ã®â€œã‚¢ã‚¯ã‚·ãƒ§ãƒ³â€ã¯ã€SMSãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚
        </div>
      </div>
    </div>
  </section>

  <!-- MODALS -->
  <!-- Action guard: SMS needed -->
  <div id="auth-modal" class="modal fixed inset-0 z-[120] items-center justify-center p-6 bg-white/90 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm border border-gray-200 p-8 shadow-xl text-center">
      <div class="w-12 h-12 bg-[var(--brand)] text-white flex items-center justify-center rounded-full mx-auto mb-4">
        <span class="ms">sms</span>
      </div>
      <h3 class="font-black text-gray-900 mb-2">SMSãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h3>
      <p class="text-xs text-gray-500 leading-relaxed mb-6">
        ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€SMSãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚<br>ï¼ˆè’ã‚‰ã—é˜²æ­¢ã®ãŸã‚ï¼‰
      </p>
      <button class="bg-[var(--brand)] text-white font-black w-full py-3 rounded-sm mb-3" onclick="openSMSFlow()">SMSèªè¨¼ã¸é€²ã‚€</button>
      <button class="text-xs text-gray-400" onclick="closeModal('auth-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

    <!-- SMS verification modal -->
  <div id="sms-modal" class="modal fixed inset-0 z-[130] items-center justify-center p-6 bg-white/90 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm border border-gray-200 p-6 shadow-xl">
      <div class="flex items-center justify-between">
        <div class="font-black text-gray-900">SMSèªè¨¼</div>
        <button class="tap text-gray-500" onclick="closeModal('sms-modal')"><span class="ms">close</span></button>
      </div>

      <!-- step 1: phone -->
      <div id="sms-step-1" class="mt-4">
        <div class="w-12 h-12 rounded-full bg-[var(--brand)] text-white flex items-center justify-center">
          <span class="ms">sms</span>
        </div>
        <div class="font-black text-sm mt-3">é›»è©±ç•ªå·ã§ãƒ­ã‚°ã‚¤ãƒ³</div>
        <div class="text-xs text-gray-500 mt-1 leading-relaxed">
          æŠ•ç¨¿ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»é€šå ±ãƒ»ã€Œè¡ŒããŸã„ã€ã¯SMSèªè¨¼å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ï¼ˆMockï¼‰ã€‚
        </div>

        <label class="text-xs font-black text-gray-400 block mt-4 mb-1">é›»è©±ç•ªå·ï¼ˆæ—¥æœ¬ï¼‰</label>
        <input id="sms-phone" type="tel" class="w-full px-3 py-3 border border-gray-200 rounded-sm text-base focus:outline-none focus:border-[var(--brand)]" placeholder="09012345678" />
        <button class="mt-4 w-full py-3 bg-gray-900 text-white font-black rounded-sm" onclick="smsSendCode()">ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ï¼ˆMockï¼‰</button>
        <button class="mt-3 w-full py-3 bg-white text-gray-700 font-black border border-gray-200 rounded-sm" onclick="closeModal('sms-modal')">ã‚ã¨ã§</button>
      </div>

      <!-- step 2: code -->
      <div id="sms-step-2" class="mt-4 hidden">
        <div class="w-12 h-12 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center">
          <span class="ms">password</span>
        </div>
        <div class="font-black text-sm mt-3">å±Šã„ãŸ6æ¡ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
        <div class="text-xs text-gray-500 mt-1 leading-relaxed">
          â€»ãƒ¢ãƒƒã‚¯ã§ã¯ <span class="font-black text-gray-700">123456</span> ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
        </div>

        <label class="text-xs font-black text-gray-400 block mt-4 mb-1">ç¢ºèªã‚³ãƒ¼ãƒ‰</label>
        <input id="sms-code" inputmode="numeric" maxlength="6" class="w-full px-3 py-3 border border-gray-200 rounded-sm text-base tracking-widest text-center font-black focus:outline-none focus:border-[var(--brand)]" placeholder="123456" />
        <button class="mt-4 w-full py-3 bg-[var(--brand)] text-white font-black rounded-sm" onclick="smsVerifyCode()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="mt-3 w-full py-3 bg-white text-gray-700 font-black border border-gray-200 rounded-sm" onclick="smsBack()">æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

<!-- Account switcher -->
  
  <!-- Rank guard: plan creation -->
  <div id="rank-modal" class="modal fixed inset-0 z-[125] items-center justify-center p-6 bg-white/90 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm border border-gray-200 p-6 shadow-xl">
      <div class="flex items-center justify-between">
        <div class="font-black text-gray-900 flex items-center gap-2">
          <span class="ms text-[20px] text-[var(--brand)]">military_tech</span>
          ä¼ç”»ä½œæˆã®æ¡ä»¶
        </div>
        <button class="tap text-gray-500" onclick="closeModal('rank-modal')" aria-label="é–‰ã˜ã‚‹"><span class="ms">close</span></button>
      </div>

      <div class="mt-4 border border-gray-200 rounded-sm p-4 bg-white">
        <div class="text-xs text-gray-500 font-black">ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯</div>
        <div class="text-2xl font-black text-gray-900 mt-1" id="rank-modal-current">ãƒ©ãƒ³ã‚¯ 1</div>
      </div>

      <div class="mt-4">
        <div class="text-xs text-gray-500 font-black mb-2">ä¼ç”»ã‚’ä½œæˆã™ã‚‹ã«ã¯</div>
        <div class="flex items-start gap-3 p-3 border border-gray-200 rounded-sm">
          <span class="ms text-[20px] text-gray-600">check_circle</span>
          <div class="min-w-0">
            <div class="text-sm font-black text-gray-900">ãƒ©ãƒ³ã‚¯10ä»¥ä¸Š</div>
            <div class="text-xs text-gray-500 mt-1 leading-relaxed">
              æŠ•ç¨¿ãƒ»ä¼ç”»å®Œèµ°ãªã©ã€æ´»å‹•é‡ãŒä¸€å®šä»¥ä¸Šã«ãªã‚‹ã¨ãƒ©ãƒ³ã‚¯ãŒä¸ŠãŒã‚Šã¾ã™ã€‚
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <div class="text-xs text-gray-500 font-black mb-2">ãƒ©ãƒ³ã‚¯ã‚’ä¸Šã’ã‚‹ä¾‹</div>
        <div class="space-y-2">
          <div class="flex items-center gap-2 text-sm text-gray-700">
            <span class="ms text-[18px] text-gray-600">edit</span>
            æŠ•ç¨¿ã™ã‚‹
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-700">
            <span class="ms text-[18px] text-gray-600">task_alt</span>
            ä¼ç”»ã‚’å®Œèµ°ã™ã‚‹
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-700">
            <span class="ms text-[18px] text-gray-600">forum</span>
            ã‚³ãƒ¡ãƒ³ãƒˆã§å‚åŠ ã™ã‚‹
          </div>
        </div>
      </div>

      <div class="mt-6">
        <button class="bg-[var(--brand)] text-white font-black w-full py-3 rounded-sm" onclick="closeModal('rank-modal')">äº†è§£</button>
      </div>
    </div>
  </div>

  <!-- Plan create modal (MVP) -->
  <div id="plan-create-modal" class="modal fixed inset-0 z-[126] items-center justify-center p-6 bg-white/90 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm border border-gray-200 p-6 shadow-xl">
      <div class="flex items-center justify-between">
        <div class="font-black text-gray-900 flex items-center gap-2">
          <span class="ms text-[20px] text-[var(--brand)]">add</span>
          ä¼ç”»ã‚’ä½œæˆ
        </div>
        <button class="tap text-gray-500" onclick="closeModal('plan-create-modal')" aria-label="é–‰ã˜ã‚‹"><span class="ms">close</span></button>
      </div>

      <div class="mt-4">
        <label class="text-xs text-gray-500 font-black">ä¼ç”»å</label>
        <input id="plan-create-title" class="mt-2 w-full border border-gray-200 rounded-sm px-3 py-3 text-sm" placeholder="ä¾‹ï¼šçµ‚é›»ã¾ã§ï¼šã¯ã—ã”ç¸›ã‚Šï¼ˆ2è»’ï¼‰" />
      </div>

      <div class="mt-4">
        <div class="text-xs text-gray-500 font-black mb-2">ç¸›ã‚Šï¼ˆæœ€å¤§3ã¤ï¼‰</div>
        <div class="space-y-2">
          <input id="plan-create-rule1" class="w-full border border-gray-200 rounded-sm px-3 py-3 text-sm" placeholder="ä¾‹ï¼šæ–°æ©‹ã‚¨ãƒªã‚¢" />
          <input id="plan-create-rule2" class="w-full border border-gray-200 rounded-sm px-3 py-3 text-sm" placeholder="ä¾‹ï¼šäºˆç®—ã€œ3,000å††" />
          <input id="plan-create-rule3" class="w-full border border-gray-200 rounded-sm px-3 py-3 text-sm" placeholder="ä¾‹ï¼šç«‹ã¡é£²ã¿å„ªå…ˆ" />
        </div>
      </div>

      <div class="mt-6">
        <button class="bg-[var(--brand)] text-white font-black w-full py-3 rounded-sm" onclick="submitCreatePlan()">ä½œæˆ</button>
        <button class="mt-3 w-full py-2 text-xs text-gray-400" onclick="closeModal('plan-create-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div id="switcher-modal" class="modal fixed inset-0 z-[125] items-center justify-center p-6 bg-white/90 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm border border-gray-200 p-5 shadow-xl">
      <div class="flex items-center justify-between">
        <div class="font-black text-gray-900">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡æ›¿</div>
        <button class="tap text-gray-500" onclick="closeModal('switcher-modal')"><span class="ms">close</span></button>
      </div>

      <div class="mt-4">
        <div class="text-xs text-gray-500 mb-2">å€‹äºº</div>
        <button class="w-full border border-gray-200 rounded-sm p-4 flex items-center justify-between tap" onclick="switchPersona('personal')">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600"><span class="ms">person</span></div>
            <div>
              <div class="font-black text-sm" id="personal-name">â€”</div>
              <div class="text-xs text-gray-500">å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
            </div>
          </div>
          <div class="text-xs font-black text-gray-500" id="personal-active">ACTIVE</div>
        </button>

        <div class="text-xs text-gray-500 mt-4 mb-2">åº—èˆ—</div>
        <div id="switcher-shops" class="space-y-2"></div>

        <div class="text-[11px] text-gray-500 leading-relaxed mt-4">
          â€»åº—èˆ—ã¯æ³•äººç•ªå·ã§ç™»éŒ² â†’ å®Œäº†å¾Œã¯æ‹›å¾…åˆ¶ï¼ˆMockï¼‰
        </div>
      </div>
    </div>
  </div>

  <!-- Original Text Modal (AIæ•´å½¢ã®å…ƒæŠ•ç¨¿è¡¨ç¤º) -->
  <div id="original-modal" class="modal fixed inset-0 z-[120] items-center justify-center p-6 bg-white/90 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm border border-gray-200 p-6 shadow-xl">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <div class="w-9 h-9 bg-gray-900 text-white flex items-center justify-center rounded-full">
            <span class="material-symbols-rounded text-[18px]">visibility</span>
          </div>
          <div>
            <h3 class="font-black text-gray-900 text-sm leading-tight">å…ƒã®æŠ•ç¨¿</h3>
            <p class="text-[11px] text-gray-500">æœ¬äººã®å…¥åŠ›ï¼ˆã‚ªãƒªã‚¸ãƒŠãƒ«ï¼‰</p>
          </div>
        </div>
        <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('original-modal')">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
      <div class="bg-gray-50 border border-gray-200 rounded p-3 text-sm text-gray-800 leading-relaxed whitespace-pre-wrap" id="original-text"></div>
      <div class="mt-4">
        <button class="w-full bg-gray-900 text-white font-black py-3 rounded-sm" onclick="closeModal('original-modal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  
  <!-- Post Menu Modal -->
  <div id="postmenu-modal" class="modal fixed inset-0 items-end justify-center bg-black/40 z-[180]">
    <div class="w-full max-w-[414px] bg-white rounded-t-2xl px-4 pt-3 pb-5">
      <div class="w-10 h-1.5 bg-gray-200 rounded-full mx-auto mb-3"></div>
      <div class="flex items-center justify-between mb-3">
        <div class="min-w-0">
          <div class="text-sm font-black text-gray-900 truncate" id="postmenu-author">æŠ•ç¨¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
          <div class="text-[11px] text-gray-500" id="postmenu-sub">ã“ã®æŠ•ç¨¿ã«å¯¾ã™ã‚‹æ“ä½œ</div>
        </div>
        <button class="icon-only" onclick="closeModal('postmenu-modal')" aria-label="é–‰ã˜ã‚‹">
          <span class="ms">close</span>
        </button>
      </div>

      <div class="grid gap-2">
        <button class="w-full flex items-center justify-between border border-gray-200 rounded-xl px-4 py-3 text-left"
                data-action="requires-verify"
                onclick="postMenuShare()">
          <div class="flex items-center gap-3">
            <span class="ms" style="font-size:22px">share</span>
            <div>
              <div class="text-sm font-black text-gray-900">å…±æœ‰</div>
              <div class="text-[11px] text-gray-500">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆç«¯æœ«å…±æœ‰ãŒã‚ã‚Œã°èµ·å‹•ï¼‰</div>
            </div>
          </div>
          <span class="ms text-gray-400">chevron_right</span>
        </button>

        <button class="w-full flex items-center justify-between border border-gray-200 rounded-xl px-4 py-3 text-left"
                data-action="requires-verify"
                onclick="postMenuToggleMute()">
          <div class="flex items-center gap-3">
            <span class="ms" style="font-size:22px">volume_off</span>
            <div>
              <div class="text-sm font-black text-gray-900" id="postmenu-mute-label">ãƒŸãƒ¥ãƒ¼ãƒˆ</div>
              <div class="text-[11px] text-gray-500">ã“ã®æŠ•ç¨¿è€…ã®è¡¨ç¤ºã‚’æ¸›ã‚‰ã™</div>
            </div>
          </div>
          <span class="ms text-gray-400">chevron_right</span>
        </button>

        <button class="w-full flex items-center justify-between border border-rose-200 bg-rose-50 rounded-xl px-4 py-3 text-left"
                data-action="requires-verify"
                onclick="postMenuReport()">
          <div class="flex items-center gap-3">
            <span class="ms" style="font-size:22px">report</span>
            <div>
              <div class="text-sm font-black text-rose-700">é€šå ±</div>
              <div class="text-[11px] text-rose-700/70">ä¸é©åˆ‡ãªå†…å®¹ã¨ã—ã¦é‹å–¶ã«é€ã‚‹ï¼ˆMockï¼‰</div>
            </div>
          </div>
          <span class="ms text-rose-400">chevron_right</span>
        </button>

        <button class="w-full mt-2 bg-gray-100 text-gray-700 font-black py-3 rounded-xl" onclick="closeModal('postmenu-modal')">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>
  </div>




  <!-- Global Bottom Tabs (Home / Favorites / Search / Notifications) -->
  <nav id="global-tabbar" class="tabbar hidden" aria-label="ãƒœãƒˆãƒ ã‚¿ãƒ–">
    <button class="tabbtn" data-tab="home" onclick="goTab('home')"><span class="ms">home</span><span>ãƒ›ãƒ¼ãƒ </span></button>
    <button class="tabbtn" data-tab="follow" onclick="goTab('follow')"><span class="ms">favorite</span><span>ãŠæ°—ã«å…¥ã‚Š</span></button>
    <button class="tabbtn" data-tab="search" onclick="goTab('search')"><span class="ms">search</span><span>æ¤œç´¢</span></button>
    <button class="tabbtn" data-tab="plan" onclick="goTab('plan')"><span class="ms">event</span><span>ä¼ç”»</span></button>
  </nav>

  <!-- Toast -->
  <div id="toast" class="hidden absolute left-1/2 -translate-x-1/2 bottom-[108px] z-[200] bg-gray-900 text-white text-xs font-black px-4 py-2 rounded-full shadow"></div>

</div>

<script>
  // ---------- State ----------
  const state = {
    status: 'guest', // guest | member | verified(SMS)
    homeStream: 'town',
    nickname: 'ãƒ’ãƒ­ã‚·',
    avatarSeed: 1,
    rank: 1,
    customPlans: [],
    activeTab: 'home',
    plan: { joined:false, completed:false },
    favMode: 'liked', // feed | want | liked | follow
    persona: 'personal', // personal or shop:<id>
    shops: [
      // {id:'shop1', name:'å±…é…’å±‹ãƒ’ãƒ­ã‚·', corp:'1234567890123', invitedStaff:true}
    ],
    follows: new Set(),
    mutedAuthors: new Set(),
    reportedPosts: new Set(),
    wants: new Set(),
    notifications: [],
    searchQuery: '',
    menuPostId: null,
    posts: [],
    lastScreenBeforePost: 'home',
    compose: { type:'normal', planId:null, planTitle:null, ratings:{cost:null,time:null,vibe:null} },
    profile: {
      optionalAttrs: [],
      showOptionalAttrs: true,
      lastNicknameChange: 0
    }
  };


  // ---------- Rank (MVP) ----------
  function getRank(){
    const r = Number(state.rank || 1);
    return Number.isFinite(r) ? r : 1;
  }
  function bumpRank(delta){
    const d = Number(delta || 0);
    const next = Math.max(1, getRank() + (Number.isFinite(d) ? d : 0));
    state.rank = next;
    updateRankUI();
  }
  function updateRankUI(){
    const txt = 'ãƒ©ãƒ³ã‚¯ ' + String(getRank());
    const a = document.getElementById('plan-rank-label');
    if(a) a.textContent = txt;
    const b = document.getElementById('rank-modal-current');
    if(b) b.textContent = txt;
    const c = document.getElementById('account-rank');
    if(c) c.textContent = txt;
  }


  // ---------- Navigation ----------
  function setTabbarVisibility(screenId){
    const tb = document.getElementById('global-tabbar');
    if(!tb) return;
    const show = ['home','follow','search','plan','notif','account'].includes(screenId);
    tb.classList.toggle('hidden', !show);
  }

  function nav(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const target = document.getElementById('screen-'+id);
    if(target) target.classList.add('active');
    setTabbarVisibility(id);
  }
  
function goTab(tab){
    state.activeTab = tab;
    const map = { home:'home', follow:'follow', search:'search', plan:'plan' };
    nav(map[tab] || 'home');
    updateTabbars();
    if(tab==='home'){ renderHomeBanner();
    updateNotifBadges(); renderTimeline(); }
    if(tab==='follow'){ renderFavScreen(); }
    if(tab==='plan'){ renderPlan(); }
    if(tab==='search'){ renderSearch(); }
  }
  function updateTabbars(){
    const root = document.getElementById('global-tabbar');
    if(!root) return;
    root.querySelectorAll('.tabbtn').forEach(b=>{
      const t = b.getAttribute('data-tab');
      if(t===state.activeTab) b.classList.add('active');
      else b.classList.remove('active');
    });
  }


  function openAccount(){
    nav('account');
    renderAccount();
  }
  function closeAccount(){
    const map = { home:'home', follow:'follow', search:'search', plan:'plan' };
    nav(map[state.activeTab] || 'home');
  }

  // ---------- Notifications ----------
  
function getUnreadNotifCount(){
    ensureSeededNotifications();
    updateNotifBadges();
    const items = state.notifications || [];
    return items.filter(n=>!n.read).length;
  }
  function updateNotifBadges(){
    const n = getUnreadNotifCount();
    document.querySelectorAll('.notif-badge').forEach(el=>{
      if(!el) return;
      el.textContent = String(n);
      el.classList.toggle('hidden', n<=0);
    });
  }
  function openNotifications(){
    // Keep activeTab highlight; show notif screen as overlay-ish
    state._prevScreenBeforeNotif = state.activeTab || 'home';
    nav('notif');
    renderNotif();
    // Mark all read (MVP)
    (state.notifications||[]).forEach(x=>x.read=true);
    updateNotifBadges();
  }
  function closeNotifications(){
    const back = state._prevScreenBeforeNotif || (state.activeTab||'home');
    nav(back);
    // rerender current tab
    if(state.activeTab==='home'){ renderHomeBanner(); renderTimeline(); }
    if(state.activeTab==='follow'){ renderFavScreen(); }
    if(state.activeTab==='search'){ renderSearch(); }
    if(state.activeTab==='plan'){ renderPlan(); }
  }



function renderPlan(){
    const list = document.getElementById('plan-list');
    if(!list) return;

    const PLAN_DEFS = getPlanDefs();
    updateRankUI();

    // joined block (MVP)
    const joined = document.getElementById('plan-joined');
    const prog = document.getElementById('plan-progress');
    const joinedTitle = joined?.querySelector('.text-sm.font-black.mt-1');
    if(joined){
      const isJoined = !!(state.plan && state.plan.joined);
      joined.classList.toggle('hidden', !isJoined);
      if(joinedTitle && isJoined){
        joinedTitle.textContent = state.plan.title || PLAN_DEFS[state.plan.planId || 'today']?.title || 'ä¼ç”»';
      }
      if(prog){
        prog.textContent = (state.plan && state.plan.completed)
          ? 'å®Œèµ°ã—ã¾ã—ãŸã€‚ãŠã¤ã‹ã‚Œï¼'
          : 'ã‚ã¨1ã‚¹ãƒ†ãƒƒãƒ—ï¼šæŠ•ç¨¿ï¼ˆã¾ãŸã¯ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰';
      }
    }

    // list
    const plans = Object.values(PLAN_DEFS).filter(p=>p.id!=='today');
    list.innerHTML = plans.map(p=>`
      <div class="p-3 rounded-xl border border-gray-100 bg-white flex gap-3 items-start tap" onclick="openPlanDetail('${p.id}')">
        <div class="w-9 h-9 rounded-full border border-gray-100 bg-white flex items-center justify-center text-gray-500 shrink-0">
          <span class="ms">${p.icon}</span>
        </div>
        <div class="min-w-0 flex-1">
          <div class="text-sm font-black truncate">${escapeHtml(p.title)}</div>
          <div class="text-xs text-gray-500 mt-0.5">${escapeHtml(p.sub)}</div>
        </div>
        <div class="shrink-0 flex items-center">
          <button class="tap px-2 py-2 text-gray-500" aria-label="è©³ç´°" onclick="event.stopPropagation(); openPlanDetail('${p.id}')"><span class="ms">chevron_right</span></button>
        </div>
      </div>
    `).join('');
  }



function getPlanDefs(){
    const base = {
      today: {
        id:'today',
        kicker:'ä»Šæ—¥ã®ä¼ç”»',
        title:'çµ‚é›»ã¾ã§ï¼šç«‹ã¡é£²ã¿ç¸›ã‚Šï¼ˆã€œ3,000å††ï¼‰',
        sub:'ã€Œè¡ŒããŸã„ã€â†’ç¾åœ°ã§1æŠ•ç¨¿ï¼ˆã¾ãŸã¯ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰ã§å®Œèµ°ã€‚',
        icon:'flag',
        rules:['æ–°æ©‹ã‚¨ãƒªã‚¢','äºˆç®—ã€œ3,000å††','ç«‹ã¡é£²ã¿å„ªå…ˆ']
      },
      senbero: {
        id:'senbero',
        kicker:'ã¿ã‚“ãªã®ä¼ç”»',
        title:'ã›ã‚“ã¹ã‚ç¸›ã‚Šï¼ˆã€œ2,000å††ï¼‰',
        sub:'0æ¬¡ä¼šã«å¼·ã„ã€‚1è»’ã ã‘ã§ã‚‚OKã€‚',
        icon:'payments',
        rules:['äºˆç®—ã€œ2,000å††','1è»’ã§ã‚‚OK','å†™çœŸæ¨å¥¨']
      },
      smoke: {
        id:'smoke',
        kicker:'ã¿ã‚“ãªã®ä¼ç”»',
        title:'å–«ç…™ãƒ»ç¦ç…™ã§åˆ†å²ï¼ˆå¥½ã¿ä¸€è‡´ï¼‰',
        sub:'åŒã˜æ´¾é–¥ã§è¡Œå‹•ã—ã‚„ã™ãã™ã‚‹ã€‚',
        icon:'smoke_free',
        rules:['å–«ç…™å¯ or ç¦ç…™','åº—ã®é›°å›²æ°—é‡è¦–','å†™çœŸæ¨å¥¨']
      }
    };

    const customs = {};
    (state.customPlans || []).forEach(p=>{
      if(!p || !p.id) return;
      customs[p.id] = p;
    });

    return { ...base, ...customs };
  }

function joinPlan(planId){
    const defs = getPlanDefs();
    const d = defs[planId] || defs.today;
    state.plan = state.plan || {};
    state.plan.joined = true;
    state.plan.completed = false;
    state.plan.planId = d.id;
    state.plan.title = d.title;
    toast('å‚åŠ ã—ã¾ã—ãŸ');
    renderPlan();
  }

function completePlan(){
    state.plan = state.plan || {};
    const wasCompleted = !!state.plan.completed;
    if(!state.plan.joined){ state.plan.joined = true; }
    state.plan.completed = true;
    if(!wasCompleted) bumpRank(1);
    toast('å®Œèµ°ã—ã¾ã—ãŸï¼ˆMockï¼‰');
    renderPlan();
  }

function joinTodayPlan(){ joinPlan('today'); }
function completeTodayPlan(){ completePlan(); }

function openCreatePlan(){
    // guest -> SMS login
    if(state.status==='guest'){
      state._afterSmsAction = { type:'createPlan' };
      openModal('sms-modal');
      smsReset();
      return;
    }
    // rank gate
    if(getRank() < 10){
      updateRankUI();
      openModal('rank-modal');
      return;
    }
    // open create modal
    const t = document.getElementById('plan-create-title');
    const r1 = document.getElementById('plan-create-rule1');
    const r2 = document.getElementById('plan-create-rule2');
    const r3 = document.getElementById('plan-create-rule3');
    if(t) t.value = '';
    if(r1) r1.value = '';
    if(r2) r2.value = '';
    if(r3) r3.value = '';
    openModal('plan-create-modal');
  }

function submitCreatePlan(){
    if(state.status==='guest'){
      state._afterSmsAction = { type:'createPlan' };
      openModal('sms-modal');
      smsReset();
      return;
    }
    if(getRank() < 10){
      updateRankUI();
      closeModal('plan-create-modal');
      openModal('rank-modal');
      return;
    }

    const title = (document.getElementById('plan-create-title')?.value || '').trim();
    const rule1 = (document.getElementById('plan-create-rule1')?.value || '').trim()
    const rule2 = (document.getElementById('plan-create-rule2')?.value || '').trim()
    const rule3 = (document.getElementById('plan-create-rule3')?.value || '').trim()

    if(!title){
      toast('ä¼ç”»åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    const rules = [rule1, rule2, rule3].filter(Boolean).slice(0,3);
    const id = 'uplan_' + Date.now().toString(36);

    const plan = {
      id,
      kicker:'ã¿ã‚“ãªã®ä¼ç”»',
      title,
      sub:'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã®ä¼ç”»ï¼ˆMockï¼‰',
      icon:'flag',
      rules: rules.length ? rules : ['ãƒ«ãƒ¼ãƒ«æœªè¨­å®š']
    };

    if(!state.customPlans) state.customPlans = [];
    state.customPlans.unshift(plan);
    closeModal('plan-create-modal');
    toast('ä¼ç”»ã‚’ä½œæˆã—ã¾ã—ãŸ');
    renderPlan();
  }

function openPlanDetail(planId){
    state.planDetailId = planId || 'today';
    renderPlanDetail();
    nav('plan-detail');
  }

function closePlanDetail(){
    goTab('plan');
  }

function renderPlanDetail(){
    const defs = getPlanDefs();
    const d = defs[state.planDetailId || 'today'] || defs.today;

    const kicker = document.getElementById('plan-detail-kicker');
    const title = document.getElementById('plan-detail-title');
    const sub = document.getElementById('plan-detail-sub');
    const icon = document.getElementById('plan-detail-icon');
    const rules = document.getElementById('plan-detail-rules');
    const joinBtn = document.getElementById('plan-detail-joinbtn');
    const postBtn = document.getElementById('plan-detail-postbtn');

    kicker && (kicker.textContent = d.kicker || 'ä¼ç”»');
    title && (title.textContent = d.title || 'â€”');
    sub && (sub.textContent = d.sub || '');
    icon && (icon.textContent = d.icon || 'flag');
    if(rules){
      rules.innerHTML = (d.rules||[]).slice(0,6).map(r=>`
        <span class="chip chip--outline"><span class="ms">label</span>${escapeHtml(r)}</span>
      `).join('');
    }

    const joinedThis = !!(state.plan?.joined && (state.plan.planId===d.id));
    if(joinBtn){
      joinBtn.textContent = joinedThis ? 'å‚åŠ æ¸ˆã¿' : 'å‚åŠ ';
      joinBtn.disabled = joinedThis;
      joinBtn.className = joinedThis
        ? 'tap px-3 py-2 text-xs font-black rounded-lg border border-gray-200 bg-gray-50 text-gray-400'
        : 'tap px-3 py-2 text-xs font-black rounded-lg bg-[var(--brand)] text-white';
    }
    if(postBtn){
      postBtn.textContent = 'ä¼ç”»ã«æŠ•ç¨¿';
    }

    renderPlanDetailTimeline(d.id);
  }


function renderPlanDetailTimeline(planId){
    ensureSeededPosts();
    const feed = document.getElementById('plan-detail-feed');
    const empty = document.getElementById('plan-detail-empty');
    if(!feed) return;

    let posts = (state.posts || []).filter(p=>p.planId===planId);

    // Filter: reported posts (hidden)
    if(state.reportedPosts && state.reportedPosts.size){
      posts = posts.filter(p=>!state.reportedPosts.has(p.id));
    }

    // Filter: muted authors (hidden)
    if(state.mutedAuthors && state.mutedAuthors.size){
      posts = posts.filter(p=>{
        const key = normalizeFollowKey(p.author?.name || '');
        return !state.mutedAuthors.has(key);
      });
    }

    // Guest: keep small preview
    if(state.status==='guest'){
      posts = posts.slice(0,2);
    }

    if(!posts.length){
      feed.innerHTML = '';
      empty && empty.classList.remove('hidden');
      return;
    }
    empty && empty.classList.add('hidden');
    feed.innerHTML = posts.map(p=>renderPostCard(p)).join('') + `<div class="h-2"></div>`;
    bindPostOpeners();
    bindGuards();
  }

function joinPlanFromDetail(){
    joinPlan(state.planDetailId || 'today');
    renderPlanDetail();
  }

function postInPlanFromDetail(){
    const defs = getPlanDefs();
    const d = defs[state.planDetailId || 'today'] || defs.today;
    openComposer({planId:d.id, planTitle:d.title});
    toast('ä¼ç”»ã«æŠ•ç¨¿ï¼ˆMockï¼‰');
  }


function renderNotif(){
    const list = document.getElementById('notif-list');
    const empty = document.getElementById('notif-empty');
    if(!list) return;
    ensureSeededNotifications();
    const items = state.notifications || [];
    if(!items.length){
      list.innerHTML = '';
      empty && empty.classList.remove('hidden');
      return;
    }
    empty && empty.classList.add('hidden');
    list.innerHTML = items.map(n=>`
      <div class="py-3 border-b border-gray-100 flex gap-3">
        <div class="w-9 h-9 rounded-full border border-gray-100 bg-white flex items-center justify-center text-gray-500 shrink-0">
          <span class="ms">${n.icon || 'notifications'}</span>
        </div>
        <div class="min-w-0">
          <div class="text-xs text-gray-500">${escapeHtml(n.time || '')}</div>
          <div class="text-sm font-black mt-0.5 truncate">${escapeHtml(n.title || '')}</div>
          ${n.body ? `<div class="text-xs text-gray-500 mt-0.5 line-clamp-2">${escapeHtml(n.body)}</div>` : ``}
        </div>
      </div>
    `).join('');
  }
  function markAllRead(){
    guardAction(()=>toast('æ—¢èª­ã«ã—ã¾ã—ãŸï¼ˆMockï¼‰'));
  }

  // ---------- Search ----------
  function focusSearch(){
    const input = document.getElementById('search-input');
    input && input.focus();
  }
  function clearSearch(){
    const input = document.getElementById('search-input');
    if(input) input.value = '';
    state.searchQuery = '';
    renderSearch();
  }
  function onSearchInput(v){
    state.searchQuery = v;
    renderSearch();
  }
  function renderSearch(){
    const q = (state.searchQuery || '').trim();
    const suggest = document.getElementById('search-suggest');
    const results = document.getElementById('search-results');
    const empty = document.getElementById('search-empty');
    if(!suggest || !results) return;

    // suggestions
    const chips = ['ç©ºå¸­','ç«‹ã¡é£²ã¿','ãƒãƒƒãƒ”ãƒ¼ã‚¢ãƒ¯ãƒ¼','å–«ç…™å¯','ç¦ç…™','äºŒæ¬¡ä¼š','çµ‚é›»å‰','ä¸²'];
    suggest.innerHTML = `
      <div class="text-xs text-gray-500">æ³¨ç›®ãƒ¯ãƒ¼ãƒ‰</div>
      <div class="mt-2 flex flex-wrap gap-2">
        ${chips.map(c=>`<button class="tap px-3 py-1.5 border border-gray-200 rounded-sm text-xs" onclick="applySearch('${c}')">${c}</button>`).join('')}
      </div>
    `;

    // results
    ensureSeededPosts();
    let posts = state.posts || [];
    posts = posts.filter(p=>!state.reportedPosts?.has?.(p.id));
    posts = posts.filter(p=>!state.mutedAuthors?.has?.(p.author?.id || p.author));
    if(q){
      const qq = q.toLowerCase();
      posts = posts.filter(p=>{
        const t = (p.public_text||'') + ' ' + (p.original_text||'') + ' ' + (p.author?.name||'');
        return t.toLowerCase().includes(qq);
      });
    }else{
      posts = [];
    }

    if(!posts.length){
      results.innerHTML = '';
      empty && empty.classList.remove('hidden');
      return;
    }
    empty && empty.classList.add('hidden');

    results.innerHTML = posts.slice(0,30).map(p=>`
      <button class="w-full text-left py-3 border-b border-gray-100 tap" onclick="openPost('${p.id}')">
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm font-black truncate">${escapeHtml(p.author?.name || 'æŠ•ç¨¿')}</div>
          <div class="text-[11px] text-gray-400">${formatPostTime(p)}</div>
        </div>
        <div class="text-sm text-gray-700 mt-1 line-clamp-2">${escapeHtml(p.public_text || '')}</div>
      </button>
    `).join('');
  }
  function applySearch(word){
    const input = document.getElementById('search-input');
    if(input){ input.value = word; }
    state.searchQuery = word;
    renderSearch();
  }
// ---------- Favorites (Follow TL / Follow / Liked) ----------
  function setFavMode(mode){
    state.favMode = mode;
    renderFavScreen();
  }

  function renderFavScreen(){
    const btnFeed = document.getElementById('fav-tab-feed');
    const btnWant = document.getElementById('fav-tab-want');
    const btnLiked  = document.getElementById('fav-tab-liked');
    const btnFollow = document.getElementById('fav-tab-follow');
    const panelFeed = document.getElementById('fav-panel-feed');
    const panelWant = document.getElementById('fav-panel-want');
    const panelLiked  = document.getElementById('fav-panel-liked');
    const panelFollow = document.getElementById('fav-panel-follow');

    if(!btnFeed || !btnWant || !btnLiked || !btnFollow || !panelFeed || !panelWant || !panelLiked || !panelFollow) return;

    const mode = state.favMode || 'liked';

    // activate tabs
    btnFeed.classList.toggle('active', mode==='feed');
    btnWant.classList.toggle('active', mode==='want');
    btnLiked.classList.toggle('active', mode==='liked');
    btnFollow.classList.toggle('active', mode==='follow');

    // panels
    panelFeed.classList.toggle('hidden', mode!=='feed');
    panelWant.classList.toggle('hidden', mode!=='want');
    panelLiked.classList.toggle('hidden', mode!=='liked');
    panelFollow.classList.toggle('hidden', mode!=='follow');

    if(mode==='feed'){
      renderFollowFeed();
    }else if(mode==='want'){
      renderWantedPosts();
    }else if(mode==='liked'){
      renderLikedPosts();
    }
  }



  function renderFollowFeed(){
    ensureSeededPosts();
    const wrap = document.getElementById('fav-feed-timeline');
    const empty = document.getElementById('fav-feed-empty');
    if(!wrap || !empty) return;

    let posts = [...state.posts];

    // Apply safety filters (same as timeline)
    if(state.reportedPosts && state.reportedPosts.size){
      posts = posts.filter(p=>!state.reportedPosts.has(p.id));
    }
    if(state.mutedAuthors && state.mutedAuthors.size){
      posts = posts.filter(p=>{
        const key = normalizeFollowKey(p.author?.name || '');
        return !state.mutedAuthors.has(key);
      });
    }

    // Follow feed: official always + followed authors
    posts = posts.filter(p=>{
      const key = normalizeFollowKey(p.author?.name || '');
      return (p.author?.type==='official') || state.follows.has(key);
    });

    // If you follow nobody, show only official posts + empty guidance
    if(state.follows.size===0){
      posts = posts.filter(p=>p.author?.type==='official');
      empty.classList.remove('hidden');
    }else{
      empty.classList.add('hidden');
    }

    wrap.innerHTML = posts.map(p=>renderPostCard(p)).join('') + `<div class="h-6"></div>`;
    bindPostOpeners();
    bindGuards();
  }

function renderLikedPosts(){
    ensureSeededPosts();
    const wrap = document.getElementById('liked-posts');
    const empty = document.getElementById('liked-empty');
    if(!wrap || !empty) return;

    let posts = state.posts.filter(p=>!!p.userLiked);

    // Apply same safety filters as timeline
    if(state.reportedPosts && state.reportedPosts.size){
      posts = posts.filter(p=>!state.reportedPosts.has(p.id));
    }
    if(state.mutedAuthors && state.mutedAuthors.size){
      posts = posts.filter(p=>{
        const key = normalizeFollowKey(p.author?.name || '');
        return !state.mutedAuthors.has(key);
      });
    }


  function renderWantedPosts(){
    ensureSeededPosts();
    const wrap = document.getElementById('fav-want-timeline');
    const empty = document.getElementById('fav-want-empty');
    if(!wrap || !empty) return;

    const wants = state.wants || new Set();
    let posts = [...state.posts].filter(p=>wants.has(p.id));

    // Apply safety filters
    if(state.reportedPosts && state.reportedPosts.size){
      posts = posts.filter(p=>!state.reportedPosts.has(p.id));
    }
    if(state.mutedAuthors && state.mutedAuthors.size){
      posts = posts.filter(p=>!state.mutedAuthors.has(p.author.id));
    }

    if(!posts.length){
      wrap.innerHTML = '';
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');
    posts.sort((a,b)=>(b.ts||0)-(a.ts||0));
    wrap.innerHTML = posts.map(renderPostCard).join('');
    bindOpenPostHandlers(wrap);
  }

    if(posts.length === 0){
      wrap.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    // Expressive clean list (no cards)
    const rows = posts.map(p=>renderLikedRow(p)).join('');
    wrap.innerHTML = rows;
    bindGuards();
  }

  function renderLikedRow(p){
    const author = p.author || {};
    const name = author.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
    const icon = author.icon || 'person';
    const date = formatPostTime(p);
    const txt = String(p.public_text || p.text || '').replace(/\\n+/g,' ');
    const likeIcon = p.userLiked ? 'favorite' : 'favorite_border';
    const likeCount = (p.stats && typeof p.stats.like==='number') ? p.stats.like : 0;
    const cCount = (p.stats && typeof p.stats.comment==='number') ? p.stats.comment : 0;

    const avatar = (author.type==='official')
      ? `<div class="w-10 h-10 bg-white border border-gray-200 flex items-center justify-center text-[var(--brand)] rounded-full"><span class="ms">${icon}</span></div>`
      : (author.type==='shop')
        ? `<div class="w-10 h-10 bg-gray-100 flex items-center justify-center text-gray-700 rounded-full"><span class="ms">${icon}</span></div>`
        : (author.type==='ops')
          ? `<div class="w-10 h-10 bg-gray-900 text-white flex items-center justify-center rounded-full"><span class="ms">${icon}</span></div>`
          : `<div class="w-10 h-10 bg-gray-200 flex items-center justify-center text-gray-700 rounded-full"><span class="ms">${icon}</span></div>`;

    const badge = (p.kind==='official')
      ? `<span class="badge badge-official">OFFICIAL</span>`
      : (p.kind==='shop')
        ? `<span class="badge badge-shop">SHOP</span>`
        : (p.kind==='petition')
          ? `<span class="badge badge-petition">æ³¨æ„</span>`
          : (p.kind==='repair')
            ? `<span class="badge badge-repair">ä»Šå¤œãƒ¬ãƒ</span>`
            : (p.kind==='debate')
              ? `<span class="badge badge-debate">è­°è«–</span>`
              : '';

    return `
      <div class="px-4 py-3 flex items-start gap-3 border-b border-gray-100 tap" onclick="openPost('${p.id}')">
        ${avatar}
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2">
            <div class="font-black text-sm truncate">${name}</div>
            <div class="text-xs text-gray-400">${date}</div>
            ${badge}
          </div>
          <div class="text-sm text-gray-800 leading-snug mt-1 clamp2">${txt}</div>
          <div class="mt-2 flex items-center gap-4 text-xs text-gray-400">
            <span class="inline-flex items-center gap-1"><span class="ms fill" style="font-size:18px">${likeIcon}</span>${likeCount}</span>
            <span class="inline-flex items-center gap-1"><span class="ms" style="font-size:18px">chat_bubble</span>${cCount}</span>
          </div>
        </div>
        <button class="tap text-gray-400" data-action="requires-verify" onclick="event.stopPropagation(); likePost('${p.id}')">
          <span class="ms fill">${likeIcon}</span>
        </button>
      </div>
    `;
  }



// ---------- Settings (v13.4.1) ----------
  const OPTIONAL_ATTR_CANDIDATES = [
    {id:'tachinomi', label:'ç«‹ã¡é£²ã¿æ´¾', icon:'local_bar'},
    {id:'senbero',   label:'ã›ã‚“ã¹ã‚',   icon:'payments'},
    {id:'smoke',     label:'å–«ç…™å¯',     icon:'smoking_rooms'},
    {id:'nosmoke',   label:'ç¦ç…™',       icon:'smoke_free'},
    {id:'quiet',     label:'é™ã‹ã‚',     icon:'volume_off'},
    {id:'karaoke',   label:'ã‚«ãƒ©ã‚ªã‚±',   icon:'mic'},
    {id:'ramen',     label:'ã€†ãƒ©ãƒ¼ãƒ¡ãƒ³', icon:'ramen_dining'},
    {id:'late',      label:'çµ‚é›»ã¾ã§',   icon:'schedule'}
  ];

  function toggleAccountSettings(shouldOpen=true){
    // v14.0.2+: è¨­å®šã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã«çµ±åˆã—ã€å¸¸æ™‚è¡¨ç¤ºï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ç„¡ã—ï¼‰
    // ã“ã“ã¯ã€Œè¨­å®šã¸ã‚¸ãƒ£ãƒ³ãƒ—ã€ç”¨é€”ã ã‘æ®‹ã™
    state.activeTab = 'account';
    nav('account');
    updateTabbars();
    renderAccount();

    if(shouldOpen){
      const panel = document.getElementById('account-settings-panel');
      panel?.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }

  function openSettings(){
    // äº’æ›APIï¼šè¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã¦ã‚‚å£Šã‚Œãªã„ã‚ˆã†æ®‹ã™
    toggleAccountSettings(true);
  }

  function renderSettings(){
    const nickEl = document.getElementById('settings-nickname');
    const saveBtn = document.getElementById('settings-nickname-save');
    const hint = document.getElementById('settings-nickname-hint');
    const showOpt = document.getElementById('settings-show-optional');
    const grid = document.getElementById('settings-optional-grid');
    const countEl = document.getElementById('settings-optional-count');

    if(nickEl) nickEl.value = state.nickname || '';

    // monthly nickname change rule (30 days)
    const now = Date.now();
    const last = Number(state.profile?.lastNicknameChange || 0);
    const diffDays = last ? Math.floor((now - last) / (1000*60*60*24)) : 999;
    const canChange = diffDays >= 30;

    if(saveBtn){
      saveBtn.disabled = !canChange;
    }
    if(hint){
      hint.textContent = canChange
        ? 'ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™ï¼ˆæ¬¡å›ã®å¤‰æ›´ã¯ä¿å­˜å¾Œã«30æ—¥çµŒéã—ã¦ã‹ã‚‰ï¼‰'
        : `æ¬¡ã®å¤‰æ›´ã¾ã§ã‚ã¨ ${30 - diffDays} æ—¥`;
    }

    if(showOpt){
      showOpt.checked = !!state.profile?.showOptionalAttrs;
    }

    const selected = new Set(state.profile?.optionalAttrs || []);
    if(countEl) countEl.textContent = String(selected.size);

    if(grid){
      grid.innerHTML = OPTIONAL_ATTR_CANDIDATES.map(x=>{
        const on = selected.has(x.label);
        return `<button class="chip ${on?'chip--teal':'chip--outline'}" onclick="toggleOptionalAttr('${escapeHtml(x.label)}')">
          <span class="ms">${x.icon}</span>${escapeHtml(x.label)}
        </button>`;
      }).join('');
    }
  }

  function toggleOptionalAttrs(){
    state.profile.showOptionalAttrs = !!document.getElementById('settings-show-optional')?.checked;
    renderSettings();
    // rerender current screen if needed
    renderHome();
  }

  function toggleOptionalAttr(label){
    const set = new Set(state.profile.optionalAttrs || []);
    if(set.has(label)){
      set.delete(label);
    }else{
      if(set.size >= 3){
        toast('ä»»æ„ãƒãƒƒãƒ—ã¯æœ€å¤§3ã¤ã¾ã§');
        return;
      }
      set.add(label);
    }
    state.profile.optionalAttrs = Array.from(set);
    renderSettings();
    renderHome();
  }

  function saveNickname(){
    const input = document.getElementById('settings-nickname');
    const val = (input?.value || '').trim();
    if(!val){
      toast('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    const now = Date.now();
    const last = Number(state.profile?.lastNicknameChange || 0);
    const diffDays = last ? Math.floor((now - last) / (1000*60*60*24)) : 999;
    if(diffDays < 30){
      toast('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯æœˆ1å›ã¾ã§å¤‰æ›´ã§ãã¾ã™');
      renderSettings();
      return;
    }

    state.nickname = val;
    state.profile.lastNicknameChange = now;
    toast('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆMockï¼‰');
    renderSettings();
    renderHome();
  }

  function logout(){
    // keep optional prefs but reset auth + persona
    state.status = 'guest';
    state.persona = 'personal';
    state.activeTab = 'home';
    toast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆMockï¼‰');
    nav('guest');
  }

  function deleteAccount(){
    if(!confirm('é€€ä¼šã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ¢ãƒƒã‚¯ï¼šçŠ¶æ…‹ã¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ï¼‰')) return;

    state.status = 'guest';
    state.nickname = 'ãƒ’ãƒ­ã‚·';
    state.persona = 'personal';
    state.shops = [];
    state.follows = new Set();
    state.posts = [];
    state.profile.optionalAttrs = [];
    state.profile.showOptionalAttrs = true;
    state.profile.lastNicknameChange = 0;

    toast('é€€ä¼šã—ã¾ã—ãŸï¼ˆMockï¼‰');
    nav('guest');
  }

  // ---------- Splash (v13 safe) ----------
  function startSplash(){
    const run = () => {
      // å¤šé‡å®Ÿè¡Œé˜²æ­¢ï¼ˆv14+ã§ä¸å®‰å®šåŒ–ã—ãŒã¡ãªãƒã‚¤ãƒ³ãƒˆã‚’å…ˆã«æ½°ã™ï¼‰
      if (window.__splashTimerId) return;

      window.__splashTimerId = window.setTimeout(() => {
        try {
          nav('guest');
        } catch (e) {
          console.error('[Splash] nav failed:', e);
        } finally {
          window.__splashTimerId = null;
        }
      }, 1200);
    };

    // é‡è¦ï¼šDOMContentLoadedå¾Œã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè©•ä¾¡ã•ã‚Œã‚‹å ´åˆã§ã‚‚ç¢ºå®Ÿã«å‹•ãã‚ˆã†ã«ã™ã‚‹
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', run, { once: true });
    } else {
      run();
    }
  }


  // ---------- Signup flow ----------
  function checkStep1(){
    const val = document.getElementById('input-nick').value.trim();
    const btn = document.getElementById('btn-step1');
    const icon = document.getElementById('icon-preview');
    if(val.length>0){
      btn.disabled=false;
      btn.classList.remove('opacity-50','cursor-not-allowed');
      state.nickname = val;
      state.avatarSeed = Math.max(1, Math.min(9, val.length));
      icon.innerHTML = makeAvatarSVG(state.avatarSeed);
    }else{
      btn.disabled=true;
      btn.classList.add('opacity-50','cursor-not-allowed');
      icon.innerHTML = '<span class="ms" style="font-size:40px">person</span>';
    }
  }
  function simulateBadgeGen(){
    const area = document.getElementById('input-area').value;
    const birth = document.getElementById('input-birth').value;
    const container = document.getElementById('badge-container');
    const btn = document.getElementById('btn-step2');

    const badges = [];
    if(area.match(/æ–°æ©‹|æ±ç•™|å†…å¹¸ç”º|è™ãƒé–€/)){
      badges.push(tag('ğŸš‰ æ–°æ©‹ã‚¨ãƒªã‚¢'));
      badges.push(tag('ğŸ™ï¸ éƒ½å¿ƒ'));
    }
    if(birth){
      const y = new Date(birth).getFullYear();
      if(y<=1989) badges.push(tag('ğŸ§‘â€ğŸ’¼ 30-40ä»£'));
      else if(y<=1999) badges.push(tag('ğŸ§‘â€ğŸ’» ãƒŸãƒ¬ãƒ‹ã‚¢ãƒ«'));
      else badges.push(tag('ğŸ“± Zä¸–ä»£'));
    }

    container.innerHTML = badges.length ? badges.join('') : '<span class="text-xs text-gray-400">å…¥åŠ›å†…å®¹ã‹ã‚‰åˆ†æä¸­â€¦</span>';

    if(area.replace(/\\D/g,'').length>=7 && birth){
      btn.disabled=false;
      btn.classList.remove('opacity-50','cursor-not-allowed');
    }
  }
  function tag(txt){
    return `<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs font-black mr-1">${txt}</span>`;
  }
  function checkStep3(){
    const ok = document.getElementById('check-terms').checked;
    const btn = document.getElementById('btn-step3');
    if(ok){
      btn.disabled=false;
      btn.classList.remove('opacity-50','cursor-not-allowed');
    }else{
      btn.disabled=true;
      btn.classList.add('opacity-50','cursor-not-allowed');
    }
  }
  function finishSignup(){
    state.status = 'verified';
    state.persona = 'personal';
    ensureSeededPosts();
    syncHeaderAvatar();
    renderHomeBanner();
    renderTimeline();
    goTab('home');
  }
  function quickLogin(){
    // mock: SMSãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
    state.status = 'verified';
    ensureSeededPosts();
    syncHeaderAvatar();
    renderHomeBanner();
    renderTimeline();
    goTab('home');
  }

  // ---------- Home stream ----------
  function setHomeStream(v){
    state.homeStream = v;
    const a = document.getElementById('home-tab-town');
    const b = document.getElementById('home-tab-follow');
    if(!a || !b){ renderTimeline(); return; }
    if(v==='town'){
      a.className='flex-1 py-3 text-[var(--brand)] border-b-2 border-[var(--brand)]';
      b.className='flex-1 py-3 text-gray-400';
    }else{
      a.className='flex-1 py-3 text-gray-400';
      b.className='flex-1 py-3 text-[var(--brand)] border-b-2 border-[var(--brand)]';
    }
    renderTimeline();
  }

  // ---------- Guard: actions require verified ----------
  function isVerified(){ return state.status==='verified'; }
  function guardAction(){
    if(!isVerified()){
      openModal('auth-modal');
      return false;
    }
    return true;
  }
  function bindGuards(){
    document.querySelectorAll('[data-action="requires-verify"]').forEach(el=>{
      if(el.__guardBound) return;
      el.__guardBound = true;
      el.addEventListener('click', (e)=>{
        // If the element has its own onclick handler, we still want to guard first.
        if(!isVerified()){
          e.preventDefault();
          e.stopPropagation();
          openModal('auth-modal');
        }
      }, true);
    });
  }

  // ---------- SMS flow ----------
  function openSMSFlow(){
    closeModal('auth-modal');
    openModal('sms-modal');
    smsReset();
  }
  function smsReset(){
    show('sms-step-1'); hide('sms-step-2');
    const p = document.getElementById('sms-phone');
    const c = document.getElementById('sms-code');
    if(p) p.value='';
    if(c) c.value='';
  }
  function smsSendCode(){
    const phone = (document.getElementById('sms-phone')?.value || '').trim();
    if(!phone){ toast('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    hide('sms-step-1'); show('sms-step-2');
    toast('ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆMockï¼‰');
  }
  function smsBack(){
    show('sms-step-1'); hide('sms-step-2');
  }
  function smsVerifyCode(){
    const code = (document.getElementById('sms-code')?.value || '').trim();
    if(code !== '123456'){ toast('ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ï¼ˆMockï¼‰'); return; }
    state.status = 'verified';
    closeModal('sms-modal');
    renderAccount();
    renderHomeBanner();
    toast('SMSãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ');
    if(state._afterSmsAction){
      const a = state._afterSmsAction; state._afterSmsAction = null;
      if(a.type==='want' && a.postId){ toggleWantPost(a.postId); }
      if(a.type==='createPlan'){ openCreatePlan(); }
    }
  }

  // ---------- Account / Shop ----------
  function setStatus(s){
    state.status = s;
    // If guest, send to guest screen; else stay
    if(s==='guest'){
      nav('guest');
      state.activeTab='home';
    }else{
      ensureSeededPosts();
      openAccount();
    }
    renderAccount();
    renderHomeBanner();
    renderTimeline();
  }
  function renderAccount(){
    const label = document.getElementById('status-label');
    const desc = document.getElementById('status-desc');
    if(!label) return;

    const map = {
      guest: { t:'ã‚²ã‚¹ãƒˆ', d:'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¯ä¸€éƒ¨ã®ã¿ï¼ˆç™»éŒ²ã§â€œå…¨éƒ¨è¦‹ãˆã‚‹â€ï¼‰' },
      member: { t:'ä¼šå“¡ç™»éŒ²æ¸ˆã¿', d:'æŠ•ç¨¿ã¯å…¨éƒ¨é–²è¦§OKï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¸å¯ï¼‰' },
      verified: { t:'SMSãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿', d:'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè§£æ”¾ï¼ˆæ²»å®‰ã¨ä¿¡é ¼ï¼‰' }
    };
    label.textContent = map[state.status].t;
    desc.textContent = map[state.status].d;

    document.getElementById('personal-name').textContent = state.nickname || 'ãƒ’ãƒ­ã‚·';
    document.getElementById('whoami').textContent = prettyPersona();

    // Shop list in account page
    const list = document.getElementById('shop-list');
    if(list){
      list.innerHTML = state.shops.length ? state.shops.map(s=>shopRow(s,false)).join('') : '<div class="text-xs text-gray-400">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
      list.querySelectorAll('[data-switch]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = btn.getAttribute('data-switch');
          switchPersona('shop:'+id);
        });
      });
    }

    // Switcher modal shop list
    const sw = document.getElementById('switcher-shops');
    if(sw){
      sw.innerHTML = state.shops.length ? state.shops.map(s=>shopRow(s,true)).join('') : '<div class="text-xs text-gray-400 border border-gray-200 rounded-sm p-4">åº—èˆ—ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
      sw.querySelectorAll('[data-switch]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-switch');
          switchPersona('shop:'+id);
        });
      });
    }

    // active marker
    const pa = document.getElementById('personal-active');
    if(pa){
      pa.textContent = (state.persona==='personal') ? 'ACTIVE' : '';
    }

    renderSettings();

    bindGuards();
  }
  function shopRow(s, forSwitcher){
    const active = (state.persona==='shop:'+s.id);
    const right = forSwitcher ? `<div class="text-xs font-black ${active?'text-[var(--brand)]':'text-gray-500'}">${active?'ACTIVE':''}</div>` : `<button class="text-xs font-black px-3 py-2 border border-gray-200 rounded-sm" data-switch="${s.id}">åˆ‡æ›¿</button>`;
    return `
      <div class="border border-gray-200 rounded-sm p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gray-900 text-white flex items-center justify-center rounded-sm"><span class="ms">storefront</span></div>
          <div>
            <div class="font-black text-sm">${escapeHtml(s.name)}</div>
            <div class="text-xs text-gray-500">æ³•äººç•ªå·: ${maskCorp(s.corp)}</div>
          </div>
        </div>
        ${right}
      </div>
    `;
  }
  function createShop(){
    if(!guardAction()) return;
    const corp = (document.getElementById('corp-number').value || '').replace(/\\D/g,'');
    const name = (document.getElementById('shop-name').value || '').trim();
    if(corp.length!==13){
      toast('æ³•äººç•ªå·ã¯13æ¡ã§ã™');
      return;
    }
    if(!name){
      toast('åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    const id = 's'+Date.now().toString(36);
    state.shops.unshift({id, name, corp, invitedStaff:true});
    document.getElementById('corp-number').value='';
    document.getElementById('shop-name').value='';
    renderAccount();
    toast('åº—èˆ—ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  }
  function openSwitcher(){
    renderAccount();
    openModal('switcher-modal');
  }
  function switchPersona(p){
    state.persona = p;
    closeModal('switcher-modal');
    syncHeaderAvatar();
    // Update compose author and debug
    renderAccount();
    renderTimeline();
    toast('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
  }
  function prettyPersona(){
    if(state.persona==='personal') return `å€‹äºº: ${state.nickname || 'ãƒ’ãƒ­ã‚·'}`;
    const id = state.persona.split(':')[1];
    const s = state.shops.find(x=>x.id===id);
    return s ? `åº—èˆ—: ${s.name}` : 'åº—èˆ—: ä¸æ˜';
  }
  function maskCorp(c){
    if(!c || c.length<13) return c || 'â€”';
    return c.slice(0,4)+'â€¢â€¢â€¢â€¢â€¢â€¢'+c.slice(-3);
  }

  // ---------- Timeline data ----------
  function ensureSeededPosts(){
    if(state.posts.length) return;
    state.posts = seedPosts();
  }

  function ensureSeededNotifications(){
    if(state.notifications && state.notifications.length) return;
    state.notifications = seedNotifications();
    updateNotifBadges();
  }
  function seedNotifications(){
    const now = Date.now();
    return [
      { id:'n1', time:'8åˆ†å‰', icon:'local_fire_department', title:'ä»Šå¤œã®æ–°æ©‹ï¼šæ··é›‘ï¼†ã‚­ãƒ£ãƒƒãƒæ³¨æ„', body:'ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼ˆç„¡ç†ãªå‘¼ã³è¾¼ã¿ã¯ã‚¹ãƒ«ãƒ¼æ¨å¥¨ï¼‰ã€‚', read:false, ts: now-8*60*1000},
      { id:'n2', time:'25åˆ†å‰', icon:'storefront', title:'ç«‹å‘‘ã¿ã€ŒéŠ€ã®æ¨½ã€ãŒæ–°ã—ã„æŠ•ç¨¿ã‚’ã—ã¾ã—ãŸ', body:'ãƒãƒƒãƒ”ãƒ¼ã‚¢ãƒ¯ãƒ¼ï¼ˆã€œ19:00ï¼‰ãŒå§‹ã¾ã‚Šã¾ã—ãŸã€‚', read:false, ts: now-25*60*1000},
      { id:'n3', time:'55åˆ†å‰', icon:'chat_bubble', title:'ã‚ãªãŸã®æŠ•ç¨¿ã«è¿”ä¿¡ãŒãã¾ã—ãŸ', body:'ã€Œçµ‚é›»å‰ã®0æ¬¡ä¼šã€ã«ã¤ã„ã¦ã‚³ãƒ¡ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚', read:false, ts: now-55*60*1000},
    ];
  }
  function seedPosts(){
    const now = Date.now();
    return [
      {
        id:'post-1',
        kind:'trend',
        author:{type:'ops', name:'SocioVoice æ–°æ©‹', badge:'OPS', icon:'auto_awesome'},
        meta:{ts:now - 6*60*1000, time:'6åˆ†å‰', tag:'ä»Šå¤œ', tagIcon:'local_fire_department', tagTone:'amber'},
        title:'ä»Šå¤œã®æ–°æ©‹ï¼šæ··é›‘ï¼†ã‚­ãƒ£ãƒƒãƒæ³¨æ„ãƒãƒƒãƒ—ï¼ˆç›®å®‰ï¼‰',
        textPublic:'æ··é›‘ã—ã‚„ã™ã„é€šã‚Šã¨ã€å£°ã‹ã‘ãŒå¤šã„ã‚¨ãƒªã‚¢ã®ç›®å®‰ã§ã™ã€‚\nç„¡ç†ãªå‘¼ã³è¾¼ã¿ã¯ã‚¹ãƒ«ãƒ¼ã§OKã€‚ãƒˆãƒ©ãƒ–ãƒ«ã¯ç„¡ç†ã›ãšé›¢è„±ã€‚',
        actions:{ seen:true }
      },
      {
        id:'post-2',
        kind:'shop',
        author:{type:'shop', name:'ç«‹å‘‘ã¿ã€ŒéŠ€ã®æ¨½ã€', badge:'SHOP', icon:'local_bar', place:'æ–°æ©‹é§…è¥¿å£', now:true},
        meta:{ts:now - 14*60*1000, time:'14åˆ†å‰', tag:'ç©ºå¸­', tagTone:'teal', tagIcon:'event_seat'},
        planId:'today',
        planTitle:'çµ‚é›»ã¾ã§ï¼šç«‹ã¡é£²ã¿ç¸›ã‚Šï¼ˆã€œ3,000å††ï¼‰',
        text:'ã€ã€œ19:00ã€‘ãƒãƒƒãƒ”ãƒ¼ã‚¢ãƒ¯ãƒ¼ã‚„ã£ã¦ã¾ã™ã€‚ã‚µã‚¯é£²ã¿æ­“è¿ğŸº',
        media:[{type:'image', label:'Happy Hour', ratio:'video'}],
        stats:{like:23, comment:3}
      },
      {
        id:'post-3',
        kind:'user',
        author:{type:'user', name: state.nickname || 'ãƒ’ãƒ­ã‚·', badges:['ã¯ã—ã”æ´¾','0æ¬¡ä¼š'], icon:'person'},
        meta:{ts:now - 28*60*1000, time:'28åˆ†å‰'},
        planId:'today',
        planTitle:'çµ‚é›»ã¾ã§ï¼šç«‹ã¡é£²ã¿ç¸›ã‚Šï¼ˆã€œ3,000å††ï¼‰',
        textPublic:'çµ‚é›»å‰ã®0æ¬¡ä¼šã£ã¦ã€ã¿ã‚“ãªã©ã“ã‹ã‚‰å…¥ã‚‹ï¼Ÿ\nã€Œä¸€æ¯ã ã‘ãƒ»é™ã‹ã‚ã€ã ã¨è¥¿å£å´ãŒãƒ©ã‚¯ã ã£ãŸã€‚',
        stats:{like:41, comment:9}
      },
      {
        id:'post-4',
        kind:'shop',
        author:{type:'shop', name:'ä¸²ç„¼ã ã—ã‚“ã°ã—å¤ªéƒ', badge:'SHOP', icon:'restaurant', place:'çƒæ£®å£'},
        meta:{ts:now - 52*60*1000, time:'52åˆ†å‰', tag:'ãŠã™ã™ã‚', tagTone:'teal', tagIcon:'thumb_up'},
        text:'æœ¬æ—¥ã€ä¸²5æœ¬ã‚»ãƒƒãƒˆãŒå°‘ã—ãŠå¾—ã§ã™ã€‚1è»’ç›®ã«ã‚‚2è»’ç›®ã«ã‚‚ã©ã†ãã€‚',
        media:[{type:'image', label:'Yakitori Set', ratio:'video'}],
        ticket:{ title:'ä¸²5æœ¬ã‚»ãƒƒãƒˆ 50å††å¼•ã', note:'â€»19:00ã¾ã§', remain:'æ®‹ã‚Š 28æš' },
        stats:{like:19, comment:2}
      },
      {
        id:'post-5',
        kind:'discussion',
        author:{type:'user', name:'ãƒ¦ã‚¦ã‚³', badges:['å¸¸é€£'], icon:'person'},
        meta:{ts:now - 95*60*1000, time:'1æ™‚é–“åŠå‰'},
        title:'å–«ç…™OK/NGã€ã¿ã‚“ãªã¯ã©ã£ã¡æ´¾ï¼Ÿ',
        textPublic:'æ–°æ©‹ã ã¨åº—ã«ã‚ˆã£ã¦çµæ§‹é•ã†ã‚ˆã­ã€‚\nã€Œä¼šè©±ã—ãŸã„æ´¾ã€ã«ã¯ã©ã®ã‚¿ã‚¤ãƒ—ãŒæ¥½ï¼Ÿ',
        pills:[{label:'å–«ç…™OKãŒåŠ©ã‹ã‚‹', n:18},{label:'ç¦ç…™ã®æ–¹ãŒã„ã„', n:26},{label:'ã©ã£ã¡ã§ã‚‚', n:9}]
      },
      {
        id:'post-6',
        kind:'trend',
        author:{type:'system', name:'SYSTEM', badge:'TREND', icon:'whatshot'},
        meta:{ts:now - 2*60*60*1000, time:'2æ™‚é–“å‰'},
        title:'ğŸ”¥ ã„ã¾æ³¨ç›®ï¼šçµ‚é›»å‰ã®â€œã‚µã‚¯é£²ã¿â€å°ç·š',
        textPublic:'ã€Œä¸€æ¯ã ã‘ã€ã€Œé™ã‹ã‚ã€ã€Œæ—©ã‚æ’¤åã€æ´¾ã®æŠ•ç¨¿ãŒé›†ã¾ã£ã¦ã„ã¾ã™ã€‚',
        stats:{like:72, comment:21}
      },
      {
        id:'post-7',
        kind:'shop',
        author:{type:'shop', name:'é¤ƒå­ã‚¹ã‚¿ãƒ³ãƒ‰ 88', badge:'SHOP', icon:'ramen_dining', place:'SLåºƒå ´å´', now:true},
        meta:{ts:now - 3*60*60*1000, time:'3æ™‚é–“å‰'},
        text:'ã€æœ¬æ—¥ã€‘é¤ƒå­ï¼‹ãƒã‚¤ãƒœãƒ¼ãƒ«ã®ã‚»ãƒƒãƒˆã‚ã‚Šã¾ã™ã€‚0æ¬¡ä¼šã«ã‚‚ã€†ã«ã‚‚ã€‚',
        media:[{type:'image', label:'Gyoza & Highball', ratio:'video'}],
        stats:{like:34, comment:4}
      },
      {
        id:'post-8',
        kind:'debate',
        author:{type:'user', name:'ã‚«ã‚º', badges:['æ–°æ©‹å‹¤å‹™'], icon:'person'},
        meta:{ts:now - 5*60*60*1000, time:'5æ™‚é–“å‰', flag:'AIæ•´å½¢', flagIcon:'auto_fix_high', flagTone:'purple'},
        title:'ã€Œå‘¼ã³è¾¼ã¿ã€ã£ã¦æ–­ã‚Šæ–¹ã®æ­£è§£ã‚ã‚‹ï¼Ÿ',
        textPublic:'å£°ã‹ã‘ãŒå¤šã„æ™‚ã€è§’ãŒç«‹ãŸãªã„æ–­ã‚Šæ–¹ã‚’çŸ¥ã‚ŠãŸã„ã€‚\nï¼ˆâ€»è¨€ã„å›ã—ã‚’æ•´ãˆã¦è¡¨ç¤ºï¼‰',
        textOriginal:'å‘¼ã³è¾¼ã¿ã†ã–ã„ã€‚æ–­ã£ã¦ã‚‚ã¤ã„ã¦ãã‚‹æ™‚ã©ã†ã™ã‚Šã‚ƒã„ã„ã®ï¼Ÿ',
        actions:{reacts:[{k:'ğŸ¤” æ‡¸å¿µã‚ã‚Š', n:15, needVerify:true},{k:'ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢', n:12, needVerify:true}]},
        stats:{like:58, comment:17}
      },
      {
        id:'post-9',
        kind:'shop',
        author:{type:'shop', name:'ç«‹ã¡é£Ÿã„ ãã°ä¸¸ï¼ˆæ–°æ©‹ï¼‰', badge:'SHOP', icon:'restaurant', place:'é§…å‰', now:false},
        meta:{ts:now - 7*60*60*1000, time:'7æ™‚é–“å‰', tag:'ã€†', tagTone:'slate', tagIcon:'nightlight'},
        text:'ã€†ã«ã©ã†ãã€‚ä»Šå¤œã¯å¤©ã·ã‚‰ãŒæšãŒã£ã¦ã¾ã™ã€‚',
        stats:{like:12, comment:0}
      }
    ];
  }

  function renderHomeBanner(){
    const el = document.getElementById('home-banner');
    if(!el) return;
    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä¸Šã®UIèª¬æ˜ã¯çœç•¥ï¼ˆè¦æœ›ã«ã‚ˆã‚Šï¼‰ã€‚
    el.innerHTML = '';
    el.classList.add('hidden');
}

function renderTimeline(){
    ensureSeededPosts();
    const tl = document.getElementById('timeline');
    if(!tl) return;

    let posts = [...state.posts];

    // Filter: reported posts (hidden)
    if(state.reportedPosts && state.reportedPosts.size){
      posts = posts.filter(p=>!state.reportedPosts.has(p.id));
    }

    // Filter: muted authors (hidden)
    if(state.mutedAuthors && state.mutedAuthors.size){
      posts = posts.filter(p=>{
        const key = normalizeFollowKey(p.author?.name || '');
        return !state.mutedAuthors.has(key);
      });
    }

    // Follow stream: show only followed + official (as baseline) for mock
    if(state.homeStream==='follow'){
      posts = posts.filter(p=>{
        if(p.author.type==='official') return true;
        const key = normalizeFollowKey(p.author.name);
        return state.follows.has(key);
      });
    }

    // HOT SHINBASHI picks should be computed before guest slicing
    const hotPicks = (state.status==='guest') ? [] : getHotShinbashiPicks(posts);

    // In guest mode (preview), user should be on guest screen; still keep safe:
    if(state.status==='guest'){
      posts = posts.slice(0,2);
    }

    // Build timeline with an inserted "HOT SHINBASHI" module after 2 posts (recommended)
    const parts = [];
    posts.forEach((p, idx)=>{
      parts.push(renderPostCard(p));
      if(idx===1 && hotPicks.length){
        parts.push(renderHotShinbashiModule(hotPicks));
      }
    });

    // If there were <2 posts but we still have picks, append at end
    if(posts.length<2 && hotPicks.length){
      parts.push(renderHotShinbashiModule(hotPicks));
    }

    tl.innerHTML = parts.join('') + `<div class="h-6"></div>`;
    bindPostOpeners();
    bindGuards();
  }

  // HOT SHINBASHI: rule-based picks (MVP)
  function getHotShinbashiPicks(posts){
    const kws = ['æ–°æ©‹','çƒæ£®','SL','ã‚¬ãƒ¼ãƒ‰ä¸‹','ç«‹ã¡é£²','ç«‹å‘‘','ãƒã‚¤ãƒœãƒ¼ãƒ«','ä¸²','é¤ƒå­','çµ‚é›»','0æ¬¡ä¼š','äºŒæ¬¡ä¼š','ã‚µã‚¯é£²','è¥¿å£','æ±å£','æ±ç•™'];
    const now = Date.now();
    const DAY = 24*60*60*1000;

    const scored = (posts||[])
      .filter(p=>Array.isArray(p.media) && p.media.length && p.media[0].type==='image')
      .filter(p=>{
        const ts = p?.meta?.ts;
        if(typeof ts==='number' && Number.isFinite(ts)){
          return (now - ts) <= DAY;
        }
        return true; // if unknown, keep in MVP
      })
      .map(p=>{
        const hay = `${p.title||''}\n${getPublicText(p)||''}\n${(p.text||'')}\n${(p.author?.name||'')}`.toLowerCase();
        const kwHit = kws.reduce((acc, w)=>{
          return acc + (hay.includes(String(w).toLowerCase()) ? 1 : 0);
        }, 0);

        const like = Number(p?.stats?.like||0);
        const comment = Number(p?.stats?.comment||0);
        const wantBoost = (state.wants && state.wants.has(p.id)) ? 6 : 0;

        // Prefer user posts slightly over shop posts for "SNSã£ã½ã•"
        const typeBoost = p.author?.type==='user' ? 6 : (p.author?.type==='shop' ? 2 : 0);

        // Freshness boost (smaller is better)
        const ts = Number(p?.meta?.ts||now);
        const minutesAgo = Math.max(0, Math.round((now - ts)/60000));
        const freshBoost = Math.max(0, 25 - Math.min(25, Math.floor(minutesAgo/10))); // up to +25

        const score = kwHit*6 + like + comment*2 + wantBoost + typeBoost + freshBoost;
        return {p, score};
      })
      .sort((a,b)=>b.score-a.score);

    // De-dup by author (max 2) to avoid "åº—å®£ä¼" domination
    const byAuthor = new Map();
    const picks = [];
    for(const it of scored){
      const k = normalizeFollowKey(it.p.author?.name || 'unknown');
      const n = byAuthor.get(k) || 0;
      if(n>=2) continue;
      byAuthor.set(k, n+1);
      picks.push(it.p);
      if(picks.length>=6) break;
    }
    return picks;
  }

  function renderHotShinbashiModule(picks){
    const cards = (picks||[]).map(p=>{
      const m = (p.media||[])[0];
      const img = m ? `<div class="img-placeholder w-full aspect-video rounded-sm">[Image: ${escapeHtml(m.label||'Photo')}]</div>` : '';
      const dt = formatPostTime(p);
      const name = escapeHtml(p.author?.name || '');
      const meta = `<div class="mt-2 text-[11px] text-gray-500 flex items-center justify-between gap-2">
          <span class="truncate">${name}</span>
          <span class="shrink-0">${dt}</span>
        </div>`;
      return `<div class="hot-card tap" role="button" tabindex="0" data-open="${p.id}">
        ${img}
        ${meta}
      </div>`;
    }).join('');

    return `
      <section class="bg-white border-b border-gray-100 px-4 py-4">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2 min-w-0">
            <span class="ms text-[18px] text-[var(--brand)]">local_fire_department</span>
            <div class="min-w-0">
              <div class="text-sm font-black tracking-wide truncate">HOT SHINBASHI</div>
              <div class="text-[11px] text-gray-500">ç›´è¿‘24hã®å†™çœŸæŠ•ç¨¿ã‹ã‚‰ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
            </div>
          </div>
          <button class="tap px-2 py-2 rounded-full" onclick="toast('ç‰¹é›†ã®æ¡ä»¶ï¼ˆMockï¼‰')" aria-label="è©³ç´°">
            <span class="ms text-[18px] text-gray-400">info</span>
          </button>
        </div>
        <div class="flex gap-3 overflow-x-auto pb-1 -mx-1 px-1">
          ${cards || `<div class="text-xs text-gray-400">ã¾ã å†™çœŸæŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`}
        </div>
      </section>
    `;
  }

  function normalizeFollowKey(name){
    const map = {
      'SocioVoice æ–°æ©‹':'ops_shinbashi',
      'ç«‹å‘‘ã¿ã€ŒéŠ€ã®æ¨½ã€':'bar_ginnotaru',
      'ä¸²ç„¼ã ã—ã‚“ã°ã—å¤ªéƒ':'kushiyaki_taro',
      'é¤ƒå­ã‚¹ã‚¿ãƒ³ãƒ‰ 88':'gyoza_88',
      'ç«‹ã¡é£Ÿã„ ãã°ä¸¸ï¼ˆæ–°æ©‹ï¼‰':'sobamaru_shinbashi'
    };
    return map[name] || name;
  }

    function getPublicText(p){
        // å…¬é–‹ã•ã‚Œã‚‹æœ¬æ–‡ï¼šAIæ•´å½¢æ¸ˆã¿ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
        return (p && typeof p.textPublic === 'string' && p.textPublic.trim().length) ? p.textPublic : (p.text || '');
    }


  function formatPostTime(p){
    try{
      const ts = p?.meta?.ts;
      const d = (typeof ts === 'number' && Number.isFinite(ts)) ? new Date(ts) : null;
      if(d){
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}/${mm}/${dd}/`;
      }
    }catch(e){}
    // fallback
    const raw = p?.meta?.time || '';
    return raw ? String(raw) : '';
  }


    function hasOriginalText(p){
        if(!p || typeof p.textOriginal !== 'string') return false;
        const o = p.textOriginal.trim();
        const pub = getPublicText(p).trim();
        return o.length > 0 && o !== pub;
    }



  function renderPostCard(p){
    const commonHeader = renderPostHeader(p);
    const body = renderPostBody(p);
    const kindClass = (p.kind==='official') ? 'post-official'
      : (p.kind==='progress' ? 'post-progress'
      : (p.kind==='trend' ? 'post-trend' : ''));
    const bgClass = (p.kind==='official' || p.kind==='progress' || p.kind==='trend') ? '' : 'bg-white';
    return `<article class="${kindClass} p-4 border-b border-gray-100 ${bgClass} tap" data-open="${p.id}">${commonHeader}${body}</article>`;
  }

  function renderPostHeader(p){
    const icon = p.author.icon || 'person';

    const iconBox = p.author.type==='official'
      ? `<div class="w-11 h-11 bg-white border border-gray-200 flex items-center justify-center text-[var(--brand)] rounded-full"><span class="ms">${icon}</span></div>`
      : (p.author.type==='ops'
        ? `<div class="w-11 h-11 bg-gray-900 text-white flex items-center justify-center rounded-full"><span class="ms">${icon||'auto_awesome'}</span></div>`
        : (p.author.type==='shop'
          ? `<div class="w-11 h-11 bg-gray-100 flex items-center justify-center text-gray-700 rounded-full"><span class="ms">${icon}</span></div>`
          : `<div class="w-11 h-11 bg-gray-200 rounded-full flex items-center justify-center text-gray-600"><span class="ms">person</span></div>`
        )
      );

    const dt = formatPostTime(p);
    const wanted = state.wants && state.wants.has(p.id);
    const wantIcon = wanted ? 'star' : 'star_border';

    return `
      <div class="flex items-center justify-between gap-3 mb-3">
        <div class="flex items-center gap-3 min-w-0">
          ${iconBox}
          <div class="min-w-0">
            <div class="name-row flex items-center gap-2 min-w-0">
              <span class="font-black text-[15px] text-gray-900 truncate max-w-[16.5rem]">${escapeHtml(p.author.name)}</span>
              ${dt ? `<span class="text-[11px] text-gray-500 font-bold shrink-0">${escapeHtml(dt)}</span>` : ``}
            </div>
          </div>
        </div>

        <div class="flex items-center gap-1">
          <button class="icon-only" aria-label="è¡ŒããŸã„" onclick="event.stopPropagation(); toggleWantPost('${p.id}')">
            <span class="ms">${wantIcon}</span>
          </button>
          <button class="icon-only" aria-label="æŠ•ç¨¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼" onclick="openPostMenu('${p.id}'); event.stopPropagation();">
            <span class="ms">more_horiz</span>
          </button>
        </div>
      </div>
    `;
  }

  function renderMetaChips(p){
    const chips = [];

    // Type chips
    if(p.author.type==='official'){
      chips.push(`<span class="chip chip--teal"><span class="ms">verified</span>${escapeHtml(p.author.badge||'OFFICIAL')}</span>`);
    }
    if(p.author.type==='ops'){
      const label = p.author.badge || 'SYSTEM';
      chips.push(`<span class="chip chip--slate"><span class="ms">auto_awesome</span>${escapeHtml(label)}</span>`);
    }
    if(p.author.type==='shop'){
      chips.push(`<span class="chip chip--slate"><span class="ms">storefront</span>SHOP</span>`);
    }
    if(p.author.type==='user' && Array.isArray(p.author.badges)){
      p.author.badges.forEach(b=>{
        chips.push(`<span class="chip chip--outline">${escapeHtml(b)}</span>`);
      });

    // Optional user attributes (selected in Settings)
    if(p.author.type==='user' && state.profile?.showOptionalAttrs){
      (state.profile.optionalAttrs||[]).forEach(a=>{
        chips.push(`<span class="chip chip--outline"><span class="ms">label</span>${escapeHtml(a)}</span>`);
      });
    }

    }

    // Plan
    if(p.planId){
      const label = p.planTitle || 'ä¼ç”»';
      chips.push(`<span class="chip chip--outline"><span class="ms">flag</span>${escapeHtml(label)}</span>`);
    }

    // Place / time
    if(p.author.place){
      chips.push(`<span class="chip chip--outline"><span class="ms">place</span>${escapeHtml(p.author.place)}</span>`);
    }

    // Tag (icon-based)
    if(p.meta?.tag){
      const tone = p.meta.tagTone
        || (p.kind==='official' ? 'teal' : (p.kind==='trend' ? 'amber' : (p.kind==='progress' ? 'slate' : 'slate')));
      const iconName = p.meta.tagIcon
        || (p.kind==='official' ? 'campaign' : (p.kind==='trend' ? 'local_fire_department' : (p.kind==='progress' ? 'insights' : 'label')));
      chips.push(`<span class="chip chip--${tone}"><span class="ms">${iconName}</span>${escapeHtml(p.meta.tag)}</span>`);
    }

    // Flag (e.g., AIæ•´å½¢)
    if(p.meta?.flag){
      const tone = p.meta.flagTone || 'purple';
      const iconName = p.meta.flagIcon || (p.meta.flag==='AIæ•´å½¢' ? 'auto_fix_high' : 'info');
      chips.push(`<span class="chip chip--${tone}"><span class="ms">${iconName}</span>${escapeHtml(p.meta.flag)}</span>`);
    }

    // NOW (shop)
    if(p.author.now){
      chips.push(`<span class="chip chip--amber"><span class="ms">local_fire_department</span>NOW</span>`);
    }

    // Ratings (3-axis)
    if(p.ratings){
      const mapCost = {1:'å®‰ã„',2:'ãµã¤ã†',3:'é«˜ã‚'};
      const mapTime = {1:'æ—©ã„',2:'ãµã¤ã†',3:'é…ã„'};
      const mapVibe = {1:'é™ã‹',2:'ãµã¤ã†',3:'è³‘ã‚„ã‹'};
      if(p.ratings.cost) chips.push(`<span class="chip chip--outline"><span class="ms">paid</span>ã‚³ã‚¹ãƒ‘:${escapeHtml(mapCost[p.ratings.cost]||'')}</span>`);
      if(p.ratings.time) chips.push(`<span class="chip chip--outline"><span class="ms">schedule</span>ã‚¿ã‚¤ãƒ‘:${escapeHtml(mapTime[p.ratings.time]||'')}</span>`);
      if(p.ratings.vibe) chips.push(`<span class="chip chip--outline"><span class="ms">groups</span>é›°å›²æ°—:${escapeHtml(mapVibe[p.ratings.vibe]||'')}</span>`);
    }


    // Machi-Report chip (è¡—ãƒ¬ãƒ)
    if(p.kind==='report'){
      const rc = getReportCategory(p.reportCategory);
      chips.push(`<span class="chip chip--${rc.tone}"><span class="ms">${rc.icon}</span>è¡—ãƒ¬ãƒãƒ»${escapeHtml(rc.label)}</span>`);
    }

    if(!chips.length) return '';
    return `<div class="mt-3 mb-4 flex flex-wrap gap-2">${chips.join('')}</div>`;
  }

  function renderPostBody(p){
    const pad = `pl-[3.25rem]`;
    const title = p.title ? `<h3 class="font-black text-sm mb-1">${escapeHtml(p.title)}</h3>` : '';
    const text = getPublicText(p) ? `<p class="text-sm text-gray-900 mb-3 leading-relaxed whitespace-pre-line">${escapeHtml(getPublicText(p))}</p>` : '';

    const media = (p.media||[]).length ? renderMedia(p.media) : '';
    const pinmap = p.pinMap ? `
      <div class="mb-3">
        <div class="text-[11px] text-gray-500 mb-2 flex items-center gap-2"><span class="ms" style="font-size:16px">location_on</span> ãƒ”ãƒ³ç•™ã‚ãƒãƒƒãƒ—</div>
        <div class="img-placeholder w-full aspect-video rounded-sm">[Pinned Map]</div>
      </div>` : '';

    const actions = renderActions(p);

    // Ticket block
    const ticket = p.ticket ? `
      <div class="ticket-dashed p-4 rounded-sm cursor-pointer hover:opacity-90 transition-opacity" data-action="requires-verify" onclick="toast('ã‚¯ãƒ¼ãƒãƒ³ä½¿ç”¨ï¼ˆMockï¼‰')">
        <div class="ticket-notch -left-2" style="border-right:1px dashed var(--brand)"></div>
        <div class="ticket-notch -right-2" style="border-left:1px dashed var(--brand)"></div>
        <div class="text-center">
          <p class="text-[10px] font-black text-[var(--brand)] tracking-widest mb-1">WEEKEND COUPON</p>
          <p class="text-xl font-black text-gray-800 mb-1">${escapeHtml(p.ticket.title)}</p>
          <p class="text-xs text-gray-500 mb-3">${escapeHtml(p.ticket.note||'')}</p>
          <div class="inline-block border-b border-[var(--brand)] text-[var(--brand)] text-xs font-black pb-0.5">ã‚¯ãƒ¼ãƒãƒ³ã‚’ä½¿ã† ></div>
        </div>
      </div>
      <p class="text-[10px] text-gray-400 mt-2 text-right">${escapeHtml(p.ticket.remain||'')}</p>
    ` : '';

    const reportStatus = p.reportStatus ? `
      <div class="bg-gray-50 p-2 text-xs text-gray-600 border border-gray-200 rounded-sm flex items-center gap-2">
        <span class="ms" style="font-size:18px">${(p.kind==='report' ? getReportCategory(p.reportCategory).icon : 'build')}</span> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span class="font-black">${escapeHtml(p.reportStatus)}</span>
      </div>
    ` : '';

    const metaChips = renderMetaChips(p);
    const pills = (p.pills||[]).length ? `
      <div class="mt-4 mb-5 flex flex-wrap gap-2">
        ${p.pills.map(x=>{
          const label = x.label || '';
          const iconName = x.icon || (label.includes('æ‡¸å¿µ') ? 'report_problem' : (label.includes('ã‚¢ã‚¤ãƒ‡ã‚¢') ? 'lightbulb' : (label.includes('è³›åŒ') ? 'how_to_vote' : 'label')));
          return `<button class="chip chip--outline" data-action="requires-verify" onclick="toast('${escapeHtml(label)}ï¼ˆMockï¼‰')">
            <span class="ms">${iconName}</span>${escapeHtml(label)} <span class="text-slate-500 font-black">(${x.n})</span>
          </button>`;
        }).join('')}
      </div>
    ` : '';

    const petition = p.petition ? renderPetition(p.petition) : '';

    return `
      <div class="${pad}">
        ${title}
        ${text}
        ${media}
        ${pinmap}
        ${ticket}
        ${reportStatus}
        ${metaChips}
        ${pills}
        ${petition}
        ${actions}
      </div>
    `;
  }

  function renderMedia(arr){
    if(!arr || !arr.length) return '';
    const m = arr[0]; // limit: 1 image per post
    const cls = m.ratio==='square' ? 'aspect-square' : (m.ratio==='video' ? 'aspect-video' : 'h-32');
    return `<div class="img-placeholder w-full ${cls} mb-3 rounded-sm">[Image: ${escapeHtml(m.label)}]</div>`;
  }

  function renderPetition(pet){
    const pct = Math.max(0, Math.min(100, Math.round((pet.current/pet.goal)*100)));
    return `
      <div class="bg-gray-50 p-4 border border-gray-200 rounded-sm mb-2">
        <div class="flex justify-between text-[10px] font-black text-gray-500 mb-1">
          <span>è³›åŒè€…: ${pet.current.toLocaleString()}</span>
          <span>ç›®æ¨™: ${pet.goal.toLocaleString()}</span>
        </div>
        <div class="w-full h-2 bg-gray-200 mb-3 rounded-full overflow-hidden">
          <div class="h-full bg-[var(--brand)]" style="width:${pct}%"></div>
        </div>
        <button class="w-full bg-[var(--brand)] text-white text-xs font-black py-3 rounded-sm hover:opacity-90" data-action="requires-verify" onclick="toast('åŒæ„ï¼ˆMockï¼‰')">
          <span class="ms" style="font-size:18px">handshake</span> åŒæ„ã™ã‚‹
        </button>
      </div>
      <p class="text-[10px] text-gray-400 text-center">â€»åŒæ„ã«ã¯SMSãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>
    `;
  }

  function renderActions(p){
    // Official: align with others (â™¡/comment/share) â€” no special "Seen"
    if(p.kind==='official'){
      const like = p.stats?.like ?? 0;
      const comment = p.stats?.comment ?? 0;
      return `<div class="actions-row flex gap-5 text-gray-400 text-sm">
        <button class="inline-flex items-center gap-1 text-gray-500 text-sm" data-action="requires-verify" onclick="likePost('${p.id}', this)">
          <span class="ms">${p.userLiked ? 'favorite' : 'favorite_border'}</span> <span>${like}</span>
        </button>
        <button class="inline-flex items-center gap-1 text-gray-500 text-sm" data-action="requires-verify" onclick="toast('ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆMockï¼‰')">
          <span class="ms">chat_bubble</span> ${comment}
        </button>
        <button class="inline-flex items-center gap-1 text-gray-500 text-sm" data-action="requires-verify" onclick="sharePostDirect('${p.id}')">
          <span class="ms">share</span>
        </button>
      </div>`;
    }


    // Others: like/comment/share
    const like = p.stats?.like ?? 0;
    const comment = p.stats?.comment ?? 0;

    const buttons = [];
    buttons.push(`<button class="inline-flex items-center gap-1 text-gray-500 text-sm" data-action="requires-verify" onclick="likePost('${p.id}', this)"><span class="ms">${p.userLiked ? 'favorite' : 'favorite_border'}</span> <span>${like}</span></button>`);
    if(p.kind!=='shop' || comment>0){
      buttons.push(`<button class="inline-flex items-center gap-1 text-gray-500 text-sm" data-action="requires-verify" onclick="toast('ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆMockï¼‰')"><span class="ms">chat_bubble</span> ${comment}</button>`);
    }
    buttons.push(`<button class="inline-flex items-center gap-1 text-gray-500 text-sm" data-action="requires-verify" onclick="toast('å…±æœ‰ï¼ˆMockï¼‰')"><span class="ms">share</span></button>`);

    return `<div class="actions-row flex gap-5">${buttons.join('')}</div>`;
  }

  // ---------- Post detail ----------
  function bindPostOpeners(){
    document.querySelectorAll('[data-open]').forEach(el=>{
      if(el.__openBound) return;
      el.__openBound = true;
      el.addEventListener('click', (e)=>{
        // Ignore clicks on buttons inside card
        if(e.target.closest('button')) return;
        const id = el.getAttribute('data-open');
        openPost(id);
      });
    });
  }
  function openPost(id){
    state.lastScreenBeforePost = state.activeTab==='home' ? 'home' : state.activeTab;
    const p = state.posts.find(x=>x.id===id);
    if(!p) return;
    document.getElementById('post-detail').innerHTML = `
      <div class="px-0">
        ${renderPostCard(p).replace('tap','')}
        ${hasOriginalText(p) ? `<div class="px-4 pt-3"><button class="text-[11px] font-black text-gray-500 underline decoration-dotted underline-offset-4" onclick="openOriginalForPost('${p.id}')">è©±é¡Œã®å…ƒæŠ•ç¨¿ã‚’è¦‹ã‚‹</button></div>` : ''}
        <div class="px-4 pt-4">
          <div class="border border-gray-200 rounded-sm p-4">
            <div class="text-xs text-gray-500 mb-2">æ“ä½œï¼ˆæœ€å°é™ï¼‰</div>
            <div class="grid grid-cols-2 gap-2">
              <button class="py-3 text-xs font-black border border-gray-300 rounded-sm" data-action="requires-verify" onclick="toast('ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãï¼ˆMockï¼‰')">
                <span class="ms" style="font-size:18px">edit_note</span> ã‚³ãƒ¡ãƒ³ãƒˆ
              </button>
              <button class="py-3 text-xs font-black border border-gray-300 rounded-sm" data-action="requires-verify" onclick="toast('é€šå ±ï¼ˆMockï¼‰')">
                <span class="ms" style="font-size:18px">report</span> é€šå ±
              </button>
            </div>
            <div class="text-[11px] text-gray-500 mt-3 leading-relaxed">
              â€»æŠ•ç¨¿ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯SMSãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è§£æ”¾ã€‚ä¼šå“¡ç™»éŒ²ã ã‘ã§ã‚‚é–²è¦§ã¯å¯èƒ½ã€‚
            </div>
          </div>
        </div>
      </div>
    `;
    nav('post');
    bindGuards();
  }
  function backFromPost(){
    // return to last tab screen
    if(state.lastScreenBeforePost==='home') goTab('home');
    else if(state.lastScreenBeforePost==='follow') goTab('follow');
    else if(state.lastScreenBeforePost==='notif') goTab('notif');
    else openAccount();
  }

  // ---------- Composer ----------
  function openComposer(opts={}){
    // Anyone can open the UI, but posting requires verified (guard on submit)
    nav('compose');
    document.getElementById('compose-author').textContent = prettyPersona();
    document.getElementById('compose-text').value = '';
    document.getElementById('compose-pinmap').checked = false;
    state.compose.ratings = {cost:null,time:null,vibe:null};
    updateComposeRatingsUI();
    // Plan context (optional)
    const defs = getPlanDefs?.() || {};
    state.compose.planId = opts.planId || null;
    state.compose.planTitle = opts.planTitle || (opts.planId ? (defs[opts.planId]?.title || null) : null);
    updateComposePlanUI();
    state.compose.type = 'normal';
    updateComposeTypeUI();
    updatePinMapPreview();
    bindGuards();
  }
  
  function clearComposePlan(){
    state.compose.planId = null;
    state.compose.planTitle = null;
    updateComposePlanUI();
    toast('ä¼ç”»ã‚’å¤–ã—ã¾ã—ãŸ');
  }

  function updateComposePlanUI(){
    const box = document.getElementById('compose-planbox');
    const name = document.getElementById('compose-planname');
    const show = !!state.compose.planId;
    if(box) box.classList.toggle('hidden', !show);
    if(name) name.textContent = state.compose.planTitle || 'ä¼ç”»';
  }

function closeComposer(){
    goTab('home');
  }
  function setComposeType(t){
    state.compose.type = t;
    updateComposeTypeUI();
  }
  function updateComposeTypeUI(){
    const ids = ['normal','report','petition'];
    ids.forEach(x=>{
      const el = document.getElementById('type-'+x);
      if(!el) return;
      const active = state.compose.type===x;
      el.className = active
        ? 'py-3 text-xs font-black border border-[var(--brand)] text-[var(--brand)] bg-teal-50 rounded-sm'
        : 'py-3 text-xs font-black border border-gray-300 rounded-sm';
    });
  }
  
  function setComposeRating(axis, val){
    if(!state.compose.ratings) state.compose.ratings = {cost:null,time:null,vibe:null};
    const cur = state.compose.ratings[axis] ?? null;
    state.compose.ratings[axis] = (cur===val) ? null : val;
    updateComposeRatingsUI();
  }

  function updateComposeRatingsUI(){
    const r = state.compose.ratings || {cost:null,time:null,vibe:null};
    const axes = [
      {axis:'cost', ids:['rate-cost-1','rate-cost-2','rate-cost-3']},
      {axis:'time', ids:['rate-time-1','rate-time-2','rate-time-3']},
      {axis:'vibe', ids:['rate-vibe-1','rate-vibe-2','rate-vibe-3']},
    ];
    axes.forEach(a=>{
      const v = r[a.axis];
      a.ids.forEach((id, idx)=>{
        const el = document.getElementById(id);
        if(!el) return;
        const val = idx+1;
        const active = v===val;
        el.className = active
          ? 'px-3 py-2 text-xs font-black bg-[var(--brand)] text-white'
          : 'px-3 py-2 text-xs font-black bg-white text-gray-700 hover:bg-gray-50';
        // keep divider borders if present in original markup
        if(idx>0){
          el.className += ' border-l border-gray-200';
        }
      });
    });
  }

function updatePinMapPreview(){
    const box = document.getElementById('pinmap-preview');
    if(!box) return;
    box.classList.toggle('hidden', !document.getElementById('compose-pinmap').checked);
  }
  document.addEventListener('change', (e)=>{
    if(e.target && e.target.id==='compose-pinmap') updatePinMapPreview();
  });

  function submitPost(){
    if(!guardAction()) return;

    const text = (document.getElementById('compose-text').value || '').trim();
    if(!text){
      toast('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    const pin = document.getElementById('compose-pinmap').checked;
    const ratings = state.compose.ratings || {cost:null,time:null,vibe:null};

    const author = currentAuthor();
    const newId = 'u'+Date.now().toString(36);

    const p = {
      id:newId,
      kind: state.compose.type==='report' ? 'report' : (state.compose.type==='petition' ? 'petition' : (author.type==='shop'?'shop':'user')),
      author,
      meta:{ ts: Date.now(), time:'ãŸã£ãŸä»Š', tag: state.compose.type==='petition' ? 'âš ï¸ æ³¨æ„ (åŒæ„)' : null },
      title: state.compose.type==='petition' ? 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®šï¼‰' : null,
      text,
      pinMap: pin,
      ratings: (ratings.cost||ratings.time||ratings.vibe) ? ratings : null,
      stats:{ like:0, comment:0 }
    };

    if(state.compose.planId){
      p.planId = state.compose.planId;
      p.planTitle = state.compose.planTitle || null;
    }


    if(state.compose.type==='petition'){
      p.title = 'æ–°ã—ã„æ³¨æ„ï¼ˆMockï¼‰';
      p.petition = { current:0, goal:300 };
    }
    if(state.compose.type==='report'){
      // default: broaden Machi-Report beyond repair only
      p.reportCategory = state.compose.reportCategory || 'help';
      // status is mainly for negative/issue categories
      if(['repair','safety','environment'].includes(p.reportCategory)){
        p.reportStatus = 'æ‹…å½“èª²ç¢ºèªä¸­';
      }
      p.media = [
        {type:'image', label:'Report Photo', ratio:'square'}
      ];
    }

    state.posts.unshift(p);
    bumpRank(1);
    toast('æŠ•ç¨¿ã—ã¾ã—ãŸ');
    goTab('home');
    renderTimeline();
  }

  function currentAuthor(){
    if(state.persona==='personal'){
      return {type:'user', name: state.nickname || 'ãƒ’ãƒ­ã‚·', badges:['ä¼šå“¡'], icon:'person'};
    }
    const id = state.persona.split(':')[1];
    const s = state.shops.find(x=>x.id===id);
    return {type:'shop', name: s?.name || 'åº—èˆ—', badge:'SHOP', icon:'storefront', place:'â€”', now:false};
  }



  // ---------- Machi-Report (è¡—ãƒ¬ãƒ) category ----------
  const REPORT_CATEGORIES = {
    repair:      { label:'ç©ºå¸­ãƒ»æ··é›‘',     tone:'rose',  icon:'crowdsource' },
    safety:      { label:'ã‚­ãƒ£ãƒƒãƒæ³¨æ„',   tone:'rose',  icon:'report_problem' },
    environment: { label:'å–«ç…™ãƒ»ç¦ç…™',     tone:'slate', icon:'smoke_free' },
    help:        { label:'åº—é¸ã³ç›¸è«‡',     tone:'slate', icon:'help' },
    idea:        { label:'ãŠã™ã™ã‚',       tone:'amber', icon:'local_fire_department' },
    praise:      { label:'ç¥åº—',           tone:'teal',  icon:'favorite' },
  };
  function getReportCategory(key){
    return REPORT_CATEGORIES[key] || REPORT_CATEGORIES.help;
  }

  // ---------- Actions ----------
  function stampOfficial(id, btn){
    if(!guardAction()) return;
    const p = state.posts.find(x=>x.id===id);
    if(p) p.seen = true;
    // update button UI (keep same visual as other actions)
    const icon = btn.querySelector('.ms');
    const label = btn.querySelector('span:not(.ms)');
    if(icon) icon.textContent = 'check_circle';
    if(label) label.textContent = 'ç¢ºèªæ¸ˆ';
    toast('ç¢ºèªã—ã¾ã—ãŸ');
  }
  
function toggleWantPost(postId){
    const doToggle = ()=>{
      if(!state.wants) state.wants = new Set();
      if(state.wants.has(postId)){
        state.wants.delete(postId);
        toast('è¡ŒããŸã„ã‹ã‚‰å‰Šé™¤');
      }else{
        state.wants.add(postId);
        toast('è¡ŒããŸã„ã«è¿½åŠ ');
      }
      // rerender current views
      renderTimeline();
      if(state.activeTab==='follow'){ renderFavScreen(); }
      if(state.activeTab==='search'){ renderSearch(); }
      updateWantStarsInDetail();
    };

    if(state.status==='guest'){
      state._afterSmsAction = {type:'want', postId};
      openModal('sms-modal');
      smsReset();
      return;
    }
    doToggle();
  }

  function updateWantStarsInDetail(){
    // If post detail is open, re-render it to sync star icon
    const detail = document.getElementById('post-detail');
    if(!detail) return;
    const openId = detail.getAttribute('data-open');
    if(!openId) return;
    openPost(openId);
  }

function likePost(postId){
    // Guest can like (MVP: diffusion first)
const p = state.posts.find(x=>x.id===postId);
    if(!p) return;

    p.userLiked = !p.userLiked;
    if(!p.stats) p.stats = {like:0, comment:0};
    if(p.userLiked){
      p.stats.like = (p.stats.like||0) + 1;
      toast('ã„ã„ã­ï¼');
    }else{
      p.stats.like = Math.max(0, (p.stats.like||0) - 1);
      toast('ã„ã„ã­è§£é™¤');
    }

    // rerender current views to keep UI always in sync
    renderTimeline();
    if(state.activeTab==='follow' && (state.favMode==='liked' || state.favMode==='feed')){ renderFavScreen(); }
    if(document.getElementById('screen-post')?.classList.contains('active')){
      openPost(postId);
    }
  }

  function toggleFollow(btn, key){
    if(!guardAction()) return;
    if(state.follows.has(key)){
      state.follows.delete(key);
      btn.textContent='ãƒ•ã‚©ãƒ­ãƒ¼';
      btn.className='px-3 py-2 text-xs font-black border border-gray-300 rounded-sm';
      toast('ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤');
    }else{
      state.follows.add(key);
      btn.textContent='ãƒ•ã‚©ãƒ­ãƒ¼ä¸­';
      btn.className='px-3 py-2 text-xs font-black border border-[var(--brand)] text-[var(--brand)] bg-teal-50 rounded-sm';
      toast('ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸ');
    }
    // refresh follow feed if needed
    if(state.activeTab==='follow' && state.favMode==='feed') renderFavScreen();
  }

  // ---------- Avatar ----------
  function makeAvatarSVG(seed){
    const colors = ['#00897B','#2563EB','#7C3AED','#DB2777','#111827','#0F766E','#F59E0B','#10B981','#EF4444'];
    const c = colors[(seed-1)%colors.length];
    const bg = '#E0F2F1';
    return `
      <svg viewBox="0 0 100 100" class="w-full h-full">
        <rect width="100" height="100" fill="${bg}"></rect>
        <circle cx="50" cy="44" r="18" fill="${c}"></circle>
        <rect x="20" y="66" width="60" height="22" rx="11" fill="${c}" opacity="0.9"></rect>
      </svg>
    `;
  }
  function syncHeaderAvatar(){
    const els = document.querySelectorAll('.header-avatar');
    if(!els || !els.length) return;
    els.forEach((el)=>{
      if(state.persona==='personal'){
        el.innerHTML = makeAvatarSVG(state.avatarSeed);
        el.className = 'header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500';
      } else {
        // shop persona
        el.innerHTML = `<span class="ms text-[22px]">storefront</span>`;
        el.className = 'header-avatar w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center text-emerald-600';
      }
    });
  }

  // ---------- Modal helpers ----------
  function openModal(id){
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
  }
  function closeModal(id){
    const el = document.getElementById(id);
    if(el) el.classList.remove('active');
  }
  function openOriginalModal(text){
    const el = document.getElementById('original-text');
    if(el) el.textContent = text || '';
    openModal('original-modal');
  }
  function openOriginalForPost(postId){
    const p = (state.posts || []).find(x=>x.id===postId);
    if(!p || !hasOriginalText(p)) return;
    openOriginalModal(p.textOriginal || '');
  }
  function show(id){ document.getElementById(id)?.classList.remove('hidden'); }
  function hide(id){ document.getElementById(id)?.classList.add('hidden'); }

  // ---------- Toast ----------
  let toastTimer = null;
  function toast(msg){
    const el = document.getElementById('toast');
    if(!el) return;
    el.textContent = msg;
    el.classList.remove('hidden');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>el.classList.add('hidden'), 1400);
  }


  function openPostMenu(postId){
    const p = (state.posts || []).find(x=>x.id===postId);
    if(!p) return;

    state.menuPostId = postId;

    const authorName = p.author?.name || 'æŠ•ç¨¿';
    const authorKey = normalizeFollowKey(authorName);

    const authorEl = document.getElementById('postmenu-author');
    const subEl = document.getElementById('postmenu-sub');
    const muteLabel = document.getElementById('postmenu-mute-label');

    if(authorEl) authorEl.textContent = authorName;
    if(subEl) subEl.textContent = `æŠ•ç¨¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆ${formatPostTime(p) || ''}ï¼‰`.trim();

    const isMuted = state.mutedAuthors?.has(authorKey);
    if(muteLabel) muteLabel.textContent = isMuted ? 'ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤' : 'ãƒŸãƒ¥ãƒ¼ãƒˆ';

    openModal('postmenu-modal');
  }

  function getMenuPost(){
    const id = state.menuPostId;
    if(!id) return null;
    return (state.posts || []).find(x=>x.id===id) || null;
  }

  async function postMenuShare(){
    const p = getMenuPost();
    if(!p) return;
    if(!guardAction()){ closeModal('postmenu-modal'); return; }
    closeModal('postmenu-modal');

    const baseUrl = location.href.split('#')[0];
    const shareUrl = `${baseUrl}#post=${encodeURIComponent(p.id)}`;
    const shareText = `${p.author?.name || 'æŠ•ç¨¿'} / SocioVoice
${(getPublicText(p) || '').slice(0,90)}${(getPublicText(p)||'').length>90?'â€¦':''}`;

    try{
      if(navigator.share){
        await navigator.share({ title:'SocioVoice', text:shareText, url:shareUrl });
        toast('å…±æœ‰ã—ã¾ã—ãŸ');
        return;
      }
    }catch(e){
      // fallthrough to clipboard
    }

    try{
      await navigator.clipboard.writeText(shareUrl);
      toast('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    }catch(e){
      toast('å…±æœ‰ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }
  }
  async function sharePostDirect(postId){
    state.menuPostId = postId;
    await postMenuShare();
  }


  function postMenuToggleMute(){
    const p = getMenuPost();
    if(!p) return;
    if(!guardAction()){ closeModal('postmenu-modal'); return; }
    closeModal('postmenu-modal');

    const authorName = p.author?.name || '';
    const authorKey = normalizeFollowKey(authorName);

    if(state.mutedAuthors?.has(authorKey)){
      state.mutedAuthors.delete(authorKey);
      toast('ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ã—ã¾ã—ãŸ');
    }else{
      state.mutedAuthors.add(authorKey);
      toast('ãƒŸãƒ¥ãƒ¼ãƒˆã—ã¾ã—ãŸ');
    }
    renderTimeline();
  }

  function postMenuReport(){
    const p = getMenuPost();
    if(!p) return;
    if(!guardAction()){ closeModal('postmenu-modal'); return; }
    closeModal('postmenu-modal');

    state.reportedPosts?.add(p.id);
    renderTimeline();
    toast('é€šå ±ã—ã¾ã—ãŸï¼ˆMockï¼‰');
  }


  // ---------- Utilities ----------
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  }

  // Close modals on backdrop click (basic)
  ['auth-modal','sms-modal','switcher-modal','original-modal','postmenu-modal'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('click', (e)=>{
      if(e.target===el) closeModal(id);
    });
  });

  // Initial
  startSplash();
  ensureSeededPosts();
  renderTimeline();
  renderHomeBanner();
  renderAccount();
  syncHeaderAvatar();

  // Bind guards for any existing nodes
  bindGuards();
</script>
</body>
</html>
